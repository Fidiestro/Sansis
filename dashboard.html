<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanse Capital ‚Äî Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #111118;
            --bg-card: #14141d;
            --bg-card-hover: #1a1a26;
            --bg-input: #1c1c28;
            --gold: #d4a843;
            --gold-light: #e8c56d;
            --gold-dark: #b8922e;
            --gold-glow: rgba(212,168,67,0.15);
            --text-primary: #f0ede6;
            --text-secondary: #8a8a9a;
            --text-muted: #55556a;
            --border: #222233;
            --green: #4ecb8d;
            --green-bg: rgba(78,203,141,0.08);
            --red: #e74c5e;
            --red-bg: rgba(231,76,94,0.08);
            --blue: #5b8def;
            --blue-bg: rgba(91,141,239,0.08);
            --purple: #a78bfa;
            --sidebar-w: 260px;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'DM Sans',sans-serif; background:var(--bg-primary); color:var(--text-primary); min-height:100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position:fixed; top:0; left:0; width:var(--sidebar-w); height:100vh;
            background:var(--bg-secondary); border-right:1px solid var(--border);
            display:flex; flex-direction:column; z-index:100;
            transition: transform 0.3s ease;
        }

        .sidebar-logo {
            padding:28px 24px; border-bottom:1px solid var(--border);
        }
        .sidebar-logo h1 {
            font-family:'Playfair Display',serif; font-size:20px; font-weight:700; letter-spacing:1.5px;
            background:linear-gradient(135deg,var(--gold-light),var(--gold));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        }
        .sidebar-logo span { font-size:10px; color:var(--text-muted); letter-spacing:3px; text-transform:uppercase; display:block; margin-top:4px; }

        .sidebar-nav { flex:1; padding:20px 12px; }
        .nav-section { margin-bottom:24px; }
        .nav-section-title { font-size:10px; color:var(--text-muted); letter-spacing:2px; text-transform:uppercase; padding:0 12px; margin-bottom:10px; }

        .nav-item {
            display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:12px;
            color:var(--text-secondary); text-decoration:none; font-size:14px; font-weight:500;
            transition:all 0.2s; cursor:pointer; margin-bottom:2px;
        }
        .nav-item:hover { background:var(--bg-card); color:var(--text-primary); }
        .nav-item.active { background:var(--gold-glow); color:var(--gold); }
        .nav-item .icon { font-size:18px; width:24px; text-align:center; }

        .sidebar-footer {
            padding:20px 16px; border-top:1px solid var(--border);
        }
        .user-info { display:flex; align-items:center; gap:12px; }
        .user-avatar {
            width:38px; height:38px; border-radius:10px;
            background:linear-gradient(135deg,var(--gold),var(--gold-dark));
            display:flex; align-items:center; justify-content:center;
            font-weight:700; font-size:14px; color:#0a0a0f;
        }
        .user-name { font-size:13px; font-weight:600; }
        .user-email { font-size:11px; color:var(--text-muted); }

        .btn-logout {
            margin-top:12px; width:100%; padding:10px; border:1px solid var(--border); background:transparent;
            border-radius:10px; color:var(--text-secondary); font-family:'DM Sans',sans-serif; font-size:12px;
            cursor:pointer; transition:all 0.2s;
        }
        .btn-logout:hover { border-color:var(--red); color:var(--red); background:var(--red-bg); }

        /* ===== MAIN ===== */
        .main { margin-left:var(--sidebar-w); min-height:100vh; }

        .topbar {
            padding:20px 36px; display:flex; align-items:center; justify-content:space-between;
            border-bottom:1px solid var(--border); backdrop-filter:blur(10px);
            background:rgba(10,10,15,0.8); position:sticky; top:0; z-index:50;
        }
        .topbar-left h2 { font-size:22px; font-weight:600; }
        .topbar-left p { font-size:13px; color:var(--text-muted); margin-top:2px; }
        .topbar-right { display:flex; align-items:center; gap:12px; }

        .btn-action {
            padding:10px 20px; border-radius:10px; font-family:'DM Sans',sans-serif; font-size:13px;
            font-weight:600; cursor:pointer; transition:all 0.2s; border:none;
        }
        .btn-gold { background:linear-gradient(135deg,var(--gold),var(--gold-dark)); color:#0a0a0f; }
        .btn-gold:hover { box-shadow:0 4px 16px rgba(212,168,67,0.3); transform:translateY(-1px); }
        .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-secondary); }
        .btn-outline:hover { border-color:var(--gold); color:var(--gold); }

        /* Mobile menu toggle */
        .menu-toggle {
            display:none; background:none; border:none; color:var(--text-primary);
            font-size:24px; cursor:pointer; padding:4px;
        }

        .content { padding:32px 36px; }

        /* ===== BALANCE HERO ===== */
        .balance-hero {
            background:var(--bg-card); border:1px solid var(--border); border-radius:20px;
            padding:36px; margin-bottom:28px; position:relative; overflow:hidden;
        }
        .balance-hero::before {
            content:''; position:absolute; top:0;right:0; width:300px; height:300px;
            background:radial-gradient(circle,rgba(212,168,67,0.08),transparent 70%); pointer-events:none;
        }
        .balance-hero::after {
            content:''; position:absolute; bottom:0;left:0;right:0; height:1px;
            background:linear-gradient(90deg,transparent,var(--gold-glow),transparent);
        }

        .balance-label { font-size:13px; color:var(--text-muted); text-transform:uppercase; letter-spacing:2px; margin-bottom:8px; }
        .balance-amount {
            font-family:'JetBrains Mono','DM Sans',monospace; font-size:48px; font-weight:700;
            background:linear-gradient(135deg,var(--gold-light),var(--gold));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            line-height:1.1;
        }
        .balance-currency { font-size:16px; color:var(--text-secondary); margin-top:4px; }

        .balance-meta { display:flex; gap:32px; margin-top:24px; padding-top:20px; border-top:1px solid var(--border); flex-wrap:wrap; }
        .meta-item {}
        .meta-value { font-size:20px; font-weight:700; font-family:'JetBrains Mono',monospace; }
        .meta-value.green { color:var(--green); }
        .meta-value.blue { color:var(--blue); }
        .meta-label { font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-top:2px; }

        /* Progress bar */
        .goal-section { margin-top:20px; }
        .goal-header { display:flex; justify-content:space-between; font-size:12px; color:var(--text-muted); margin-bottom:8px; }
        .goal-bar { height:8px; background:var(--bg-input); border-radius:100px; overflow:hidden; }
        .goal-fill { height:100%; border-radius:100px; background:linear-gradient(90deg,var(--gold),var(--gold-light)); transition:width 1.5s ease; }

        /* ===== GRID ===== */
        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:28px; }
        .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin-bottom:28px; }

        /* ===== STAT CARDS ===== */
        .stat-card {
            background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:24px;
            transition:all 0.2s;
        }
        .stat-card:hover { border-color:var(--border); background:var(--bg-card-hover); }
        .stat-icon { font-size:24px; margin-bottom:12px; }
        .stat-value { font-size:24px; font-weight:700; font-family:'JetBrains Mono',monospace; }
        .stat-label { font-size:12px; color:var(--text-muted); margin-top:4px; text-transform:uppercase; letter-spacing:1px; }
        .stat-change { display:inline-flex; align-items:center; gap:4px; font-size:12px; margin-top:8px; padding:4px 10px; border-radius:100px; font-weight:500; }
        .stat-change.up { color:var(--green); background:var(--green-bg); }
        .stat-change.down { color:var(--red); background:var(--red-bg); }

        /* ===== CHART ===== */
        .chart-card {
            background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:28px;
        }
        .chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
        .chart-title { font-size:16px; font-weight:600; }
        .chart-subtitle { font-size:12px; color:var(--text-muted); }

        .chart-container { position:relative; height:200px; }
        .chart-svg { width:100%; height:100%; }

        /* ===== TABLE ===== */
        .table-card {
            background:var(--bg-card); border:1px solid var(--border); border-radius:16px; overflow:hidden;
        }
        .table-header { padding:24px 28px 16px; display:flex; justify-content:space-between; align-items:center; }
        .table-title { font-size:16px; font-weight:600; }

        .data-table { width:100%; border-collapse:collapse; }
        .data-table th {
            text-align:left; padding:12px 28px; font-size:11px; color:var(--text-muted);
            text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border); font-weight:500;
        }
        .data-table td { padding:16px 28px; font-size:14px; border-bottom:1px solid var(--border); }
        .data-table tr:last-child td { border-bottom:none; }
        .data-table tr:hover td { background:rgba(212,168,67,0.02); }

        .badge {
            display:inline-flex; padding:4px 12px; border-radius:100px; font-size:11px; font-weight:600; letter-spacing:0.5px;
        }
        .badge-deposit { color:var(--green); background:var(--green-bg); }
        .badge-profit { color:var(--gold); background:var(--gold-glow); }
        .badge-withdraw { color:var(--red); background:var(--red-bg); }
        .badge-active { color:var(--green); background:var(--green-bg); }

        .amount-positive { color:var(--green); font-family:'JetBrains Mono',monospace; font-weight:500; }
        .amount-negative { color:var(--red); font-family:'JetBrains Mono',monospace; font-weight:500; }
        .amount-neutral { font-family:'JetBrains Mono',monospace; font-weight:500; }

        /* ===== INVESTMENTS ===== */
        .investment-cards { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px; margin-bottom:28px; }
        .inv-card {
            background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:24px;
            position:relative; overflow:hidden; transition:all 0.2s;
        }
        .inv-card:hover { border-color:rgba(212,168,67,0.3); }
        .inv-card::before {
            content:''; position:absolute; top:0;left:0;right:0; height:3px;
            border-radius:14px 14px 0 0;
        }
        .inv-card:nth-child(1)::before { background:var(--green); }
        .inv-card:nth-child(2)::before { background:var(--gold); }
        .inv-card:nth-child(3)::before { background:var(--red); }

        .inv-type { font-size:13px; color:var(--text-secondary); font-weight:500; }
        .inv-amount { font-size:22px; font-weight:700; font-family:'JetBrains Mono',monospace; margin:8px 0; }
        .inv-meta { display:flex; justify-content:space-between; font-size:12px; color:var(--text-muted); }
        .inv-rate { color:var(--gold); font-weight:600; }

        /* ===== LOADING STATE ===== */
        .loading-state {
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            padding:60px 20px; color:var(--text-muted);
        }
        .loading-spinner {
            width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--gold);
            border-radius:50%; animation:spin 0.8s linear infinite; margin-bottom:16px;
        }
        @keyframes spin{to{transform:rotate(360deg)}}

        .error-state {
            background:var(--red-bg); border:1px solid rgba(231,76,94,0.2); border-radius:16px;
            padding:32px; text-align:center; color:var(--red);
        }
        .error-state button {
            margin-top:16px; padding:10px 24px; background:var(--red); color:white; border:none;
            border-radius:10px; cursor:pointer; font-family:'DM Sans',sans-serif; font-weight:600;
        }

        /* ===== MOBILE OVERLAY ===== */
        .sidebar-overlay {
            display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
            z-index:90; opacity:0; transition:opacity 0.3s;
        }
        .sidebar-overlay.show { display:block; opacity:1; }

        /* ===== RESPONSIVE ===== */
        @media(max-width:1024px) {
            .grid-3 { grid-template-columns:1fr 1fr; }
        }

        @media(max-width:768px) {
            .sidebar { transform:translateX(-100%); }
            .sidebar.open { transform:translateX(0); }
            .main { margin-left:0; }
            .menu-toggle { display:block; }
            .content { padding:24px 16px; }
            .topbar { padding:16px; }
            .balance-amount { font-size:32px; }
            .grid-2 { grid-template-columns:1fr; }
            .grid-3 { grid-template-columns:1fr; }
            .balance-meta { gap:20px; }
            .data-table th, .data-table td { padding:12px 16px; font-size:13px; }
            .balance-hero { padding:24px; }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeInUp {
            from { opacity:0; transform:translateY(20px); }
            to { opacity:1; transform:translateY(0); }
        }
        .animate-in { animation:fadeInUp 0.6s ease-out forwards; opacity:0; }
        .delay-1 { animation-delay:0.1s; }
        .delay-2 { animation-delay:0.2s; }
        .delay-3 { animation-delay:0.3s; }
        .delay-4 { animation-delay:0.4s; }
        .delay-5 { animation-delay:0.5s; }

        /* Scrollbar */
        ::-webkit-scrollbar { width:6px; }
        ::-webkit-scrollbar-track { background:var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
        ::-webkit-scrollbar-thumb:hover { background:var(--text-muted); }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <h1>SANSE CAPITAL</h1>
            <span>Panel de Control</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a class="nav-item active" href="#">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a class="nav-item" href="#" onclick="alert('Pr√≥ximamente'); return false;">
                    <span class="icon">üí∞</span> Inversiones
                </a>
                <a class="nav-item" href="#" onclick="alert('Pr√≥ximamente'); return false;">
                    <span class="icon">üìã</span> Movimientos
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">M√°s</div>
                <a class="nav-item" href="#" onclick="alert('Pr√≥ximamente'); return false;">
                    <span class="icon">‚öôÔ∏è</span> Configuraci√≥n
                </a>
                <a class="nav-item" href="https://wa.me/573194552890" target="_blank">
                    <span class="icon">üí¨</span> Soporte
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">--</div>
                <div>
                    <div class="user-name" id="user-name">Cargando...</div>
                    <div class="user-email" id="user-email">...</div>
                </div>
            </div>
            <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Main -->
    <main class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:16px;">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <div class="topbar-left">
                    <h2 id="greeting">Cargando...</h2>
                    <p id="date-display"></p>
                </div>
            </div>
            <div class="topbar-right">
                <a href="index.html" class="btn-action btn-outline" style="text-decoration:none;">‚Üê Ir al Home</a>
            </div>
        </div>

        <div class="content" id="dashboard-content">
            <!-- Loading state -->
            <div class="loading-state" id="loading-state">
                <div class="loading-spinner"></div>
                <p>Cargando tu informaci√≥n...</p>
            </div>
        </div>
    </main>

    <!-- Template del dashboard (se inyecta despu√©s de cargar datos) -->
    <template id="dashboard-template">
        <!-- Balance Hero -->
        <div class="balance-hero animate-in">
            <div class="balance-label">üí∞ Tu Ahorro Total</div>
            <div class="balance-amount" id="balance-display">$0</div>
            <div class="balance-currency">Pesos Colombianos (COP)</div>

            <div class="balance-meta">
                <div class="meta-item">
                    <div class="meta-value green" id="total-profit">+$0</div>
                    <div class="meta-label">Ganancias totales</div>
                </div>
                <div class="meta-item">
                    <div class="meta-value blue" id="total-invested">$0</div>
                    <div class="meta-label">Total invertido</div>
                </div>
                <div class="meta-item">
                    <div class="meta-value" id="active-count" style="color:var(--purple)">0</div>
                    <div class="meta-label">Inversiones activas</div>
                </div>
            </div>

            <div class="goal-section">
                <div class="goal-header">
                    <span>Meta de ahorro</span>
                    <span id="goal-text">0% completado</span>
                </div>
                <div class="goal-bar">
                    <div class="goal-fill" id="goal-fill" style="width:0%"></div>
                </div>
            </div>
        </div>

        <!-- Stat Cards -->
        <div class="grid-3 animate-in delay-1">
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value" id="stat-rendimiento">0%</div>
                <div class="stat-label">Rendimiento Promedio</div>
                <div class="stat-change up">‚Üë anualizado</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" id="stat-months">0</div>
                <div class="stat-label">Meses Invirtiendo</div>
                <div class="stat-change up">‚Üë activo</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíé</div>
                <div class="stat-value" id="stat-last-profit">$0</div>
                <div class="stat-label">√öltimo Rendimiento</div>
                <div class="stat-change up">‚Üë este mes</div>
            </div>
        </div>

        <!-- Chart + Investments -->
        <div class="grid-2 animate-in delay-2">
            <!-- Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Crecimiento del Ahorro</div>
                        <div class="chart-subtitle">Historial</div>
                    </div>
                </div>
                <div class="chart-container">
                    <svg class="chart-svg" id="chart-svg" viewBox="0 0 500 200" preserveAspectRatio="none"></svg>
                </div>
            </div>

            <!-- Active Investments -->
            <div class="table-card">
                <div class="table-header">
                    <span class="table-title">Inversiones Activas</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr><th>Tipo</th><th>Monto</th><th>Tasa</th></tr>
                    </thead>
                    <tbody id="investments-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Transactions -->
        <div class="table-card animate-in delay-3">
            <div class="table-header">
                <span class="table-title">√öltimos Movimientos</span>
            </div>
            <table class="data-table">
                <thead>
                    <tr><th>Fecha</th><th>Descripci√≥n</th><th>Tipo</th><th style="text-align:right">Monto</th></tr>
                </thead>
                <tbody id="transactions-tbody"></tbody>
            </table>
        </div>
    </template>

    <script>
        // ====== CONFIGURACI√ìN API ======
        const API_URL = 'https://sanse-backend-production.up.railway.app/api';

        // ====== AUTH ======
        function getToken() {
            return localStorage.getItem('sanse_access_token') || sessionStorage.getItem('sanse_access_token');
        }
        function getRefreshToken() {
            return localStorage.getItem('sanse_refresh_token') || sessionStorage.getItem('sanse_refresh_token');
        }
        function getUserData() {
            const data = localStorage.getItem('sanse_user') || sessionStorage.getItem('sanse_user');
            return data ? JSON.parse(data) : null;
        }
        function getStorage() {
            return localStorage.getItem('sanse_access_token') ? localStorage : sessionStorage;
        }

        // Verificar autenticaci√≥n
        if (!getToken()) {
            window.location.href = 'login.html';
        }

        // ====== API HELPER con auto-refresh de token ======
        async function apiFetch(endpoint, options = {}) {
            const token = getToken();
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    ...options.headers,
                },
            };

            let response = await fetch(`${API_URL}${endpoint}`, config);

            // Si el token expir√≥, intentar refresh
            if (response.status === 401) {
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    config.headers['Authorization'] = `Bearer ${getToken()}`;
                    response = await fetch(`${API_URL}${endpoint}`, config);
                } else {
                    logout();
                    return null;
                }
            }

            return response;
        }

        async function refreshAccessToken() {
            try {
                const refreshToken = getRefreshToken();
                if (!refreshToken) return false;

                const response = await fetch(`${API_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken }),
                });

                if (!response.ok) return false;

                const data = await response.json();
                const storage = getStorage();
                storage.setItem('sanse_access_token', data.accessToken);
                storage.setItem('sanse_refresh_token', data.refreshToken);
                return true;
            } catch {
                return false;
            }
        }

        // ====== UTILS ======
        function formatCOP(n) {
            return '$' + Math.round(n).toLocaleString('es-CO');
        }

        function logout() {
            localStorage.removeItem('sanse_access_token');
            localStorage.removeItem('sanse_refresh_token');
            localStorage.removeItem('sanse_user');
            sessionStorage.removeItem('sanse_access_token');
            sessionStorage.removeItem('sanse_refresh_token');
            sessionStorage.removeItem('sanse_user');
            window.location.href = 'login.html';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('show');
        }

        // ====== SET GREETING ======
        function setGreeting(userName) {
            const h = new Date().getHours();
            let g = 'Buenas noches';
            if (h >= 5 && h < 12) g = 'Buenos d√≠as';
            else if (h >= 12 && h < 19) g = 'Buenas tardes';

            const firstName = userName ? userName.split(' ')[0] : '';
            document.getElementById('greeting').textContent = `${g}, ${firstName} üëã`;

            const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('es-CO', opts);
        }

        // ====== ANIMATED NUMBER ======
        function animateNumber(elId, target, isCurrency) {
            const el = document.getElementById(elId);
            if (!el) return;
            const duration = 1500;
            const start = 0;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.round(start + (target - start) * eased);
                el.textContent = isCurrency ? formatCOP(current) : current.toLocaleString('es-CO');
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // ====== CHART ======
        function drawChart(history) {
            if (!history || !history.length) return;
            const svg = document.getElementById('chart-svg');
            if (!svg) return;
            const w = 500, h = 200, pad = 30;
            const vals = history.map(h => h.amount);
            const min = Math.min(...vals) * 0.9;
            const max = Math.max(...vals) * 1.05;

            const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];

            const points = history.map((item, i) => {
                const x = pad + (i / Math.max(history.length - 1, 1)) * (w - pad * 2);
                const y = h - pad - ((item.amount - min) / (max - min || 1)) * (h - pad * 2);
                const d = new Date(item.date);
                const label = months[d.getMonth()] + ' ' + d.getFullYear();
                return { x, y, label, ...item };
            });

            const pathD = points.map((p, i) => {
                if (i === 0) return `M ${p.x} ${p.y}`;
                const prev = points[i - 1];
                const cpx1 = prev.x + (p.x - prev.x) / 3;
                const cpx2 = prev.x + (p.x - prev.x) * 2 / 3;
                return `C ${cpx1} ${prev.y}, ${cpx2} ${p.y}, ${p.x} ${p.y}`;
            }).join(' ');

            const areaD = pathD + ` L ${points[points.length-1].x} ${h - pad} L ${points[0].x} ${h - pad} Z`;

            let svgContent = `
                <defs>
                    <linearGradient id="lineGrad" x1="0" y1="0" x2="1" y2="0">
                        <stop offset="0%" stop-color="#d4a843"/>
                        <stop offset="100%" stop-color="#e8c56d"/>
                    </linearGradient>
                    <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="rgba(212,168,67,0.2)"/>
                        <stop offset="100%" stop-color="rgba(212,168,67,0)"/>
                    </linearGradient>
                </defs>
            `;

            for (let i = 0; i < 4; i++) {
                const y = pad + (i / 3) * (h - pad * 2);
                svgContent += `<line x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}" stroke="rgba(42,42,58,0.5)" stroke-width="1" stroke-dasharray="4"/>`;
            }

            svgContent += `<path d="${areaD}" fill="url(#areaGrad)"/>`;
            svgContent += `<path d="${pathD}" fill="none" stroke="url(#lineGrad)" stroke-width="2.5" stroke-linecap="round"/>`;

            points.forEach((p) => {
                svgContent += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="var(--bg-primary)" stroke="var(--gold)" stroke-width="2"/>`;
                svgContent += `<text x="${p.x}" y="${h - 8}" text-anchor="middle" fill="var(--text-muted)" font-size="10" font-family="DM Sans">${p.label}</text>`;
            });

            svg.innerHTML = svgContent;
        }

        // ====== POPULATE DASHBOARD ======
        function populateDashboard(data, user) {
            // Inject template
            const template = document.getElementById('dashboard-template');
            const content = document.getElementById('dashboard-content');
            content.innerHTML = '';
            content.appendChild(template.content.cloneNode(true));

            // User info sidebar
            const initials = (user.fullName || user.email).split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = user.fullName || user.email;
            document.getElementById('user-email').textContent = user.email;

            // Balance
            animateNumber('balance-display', data.balance, true);

            // Totals
            document.getElementById('total-profit').textContent = '+' + formatCOP(data.totalProfit);
            document.getElementById('total-invested').textContent = formatCOP(data.totalInvested);
            document.getElementById('active-count').textContent = data.activeInvestments;

            // Goal
            const goal = data.monthlyGoal || 20000000;
            const pct = Math.min(100, Math.round((data.balance / goal) * 100));
            document.getElementById('goal-text').textContent = `${pct}% ‚Äî Meta: ${formatCOP(goal)}`;
            setTimeout(() => {
                document.getElementById('goal-fill').style.width = pct + '%';
            }, 500);

            // Stats
            document.getElementById('stat-rendimiento').textContent = data.avgRate + '%';
            document.getElementById('stat-months').textContent = data.monthsInvesting;
            document.getElementById('stat-last-profit').textContent = formatCOP(data.lastProfit);

            // Investments table
            const invBody = document.getElementById('investments-tbody');
            if (data.investments.length === 0) {
                invBody.innerHTML = '<tr><td colspan="3" style="color:var(--text-muted);text-align:center;padding:24px;">Sin inversiones activas</td></tr>';
            } else {
                data.investments.forEach(inv => {
                    invBody.innerHTML += `
                        <tr>
                            <td>${inv.type}</td>
                            <td class="amount-neutral">${formatCOP(inv.amount)}</td>
                            <td><span class="inv-rate">${inv.rate}% anual</span></td>
                        </tr>
                    `;
                });
            }

            // Transactions table
            const txBody = document.getElementById('transactions-tbody');
            if (data.transactions.length === 0) {
                txBody.innerHTML = '<tr><td colspan="4" style="color:var(--text-muted);text-align:center;padding:24px;">Sin movimientos</td></tr>';
            } else {
                data.transactions.forEach(tx => {
                    const typeLabels = { deposit:'Dep√≥sito', profit:'Rendimiento', withdraw:'Retiro' };
                    const badgeClass = { deposit:'badge-deposit', profit:'badge-profit', withdraw:'badge-withdraw' };
                    const amountClass = tx.type === 'withdraw' ? 'amount-negative' : 'amount-positive';
                    const prefix = tx.type === 'withdraw' ? '-' : '+';
                    const dateStr = new Date(tx.date).toLocaleDateString('es-CO', { day:'numeric', month:'short', year:'numeric' });

                    txBody.innerHTML += `
                        <tr>
                            <td style="color:var(--text-secondary)">${dateStr}</td>
                            <td>${tx.description || '-'}</td>
                            <td><span class="badge ${badgeClass[tx.type] || ''}">${typeLabels[tx.type] || tx.type}</span></td>
                            <td class="${amountClass}" style="text-align:right">${prefix}${formatCOP(tx.amount)}</td>
                        </tr>
                    `;
                });
            }

            // Chart
            drawChart(data.balanceHistory);
        }

        // ====== SHOW ERROR STATE ======
        function showError(message) {
            const content = document.getElementById('dashboard-content');
            content.innerHTML = `
                <div class="error-state">
                    <p>‚ö†Ô∏è ${message}</p>
                    <button onclick="loadDashboard()">Reintentar</button>
                    <button onclick="logout()" style="background:transparent;border:1px solid var(--red);color:var(--red);margin-left:8px;">Cerrar sesi√≥n</button>
                </div>
            `;
        }

        // ====== LOAD DASHBOARD DATA ======
        async function loadDashboard() {
            const content = document.getElementById('dashboard-content');
            content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Cargando tu informaci√≥n...</p></div>';

            try {
                const user = getUserData();
                if (user) {
                    setGreeting(user.fullName || user.email);
                }

                const response = await apiFetch('/dashboard/summary');
                if (!response) return; // logout ya fue llamado

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Error cargando datos');
                }

                const data = await response.json();
                populateDashboard(data, user || { email: 'Usuario', fullName: 'Usuario' });

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showError(error.message || 'No se pudo conectar con el servidor.');
            }
        }

        // ====== SET DATE ======
        const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
        document.getElementById('date-display').textContent = new Date().toLocaleDateString('es-CO', opts);

        // ====== INIT ======
        const userData = getUserData();
        if (userData) {
            setGreeting(userData.fullName || userData.email);
            const initials = (userData.fullName || userData.email).split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = userData.fullName || userData.email;
            document.getElementById('user-email').textContent = userData.email;
        }
        loadDashboard();
    </script>
</body>
</html>
