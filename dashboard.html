<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî Sanse Capital</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --gold: #C9A84C;
            --gold-light: #E8C96A;
            --gold-dim: rgba(201,168,76,0.15);
            --dark: #090909;
            --dark-2: #111111;
            --dark-3: #181818;
            --text: #E8E4DC;
            --text-muted: #7A7670;
            --border: rgba(201,168,76,0.12);
            --border-hover: rgba(201,168,76,0.35);
            --green: #4ecb8d;
            --green-bg: rgba(78,203,141,0.1);
            --red: #e74c5e;
            --red-bg: rgba(231,76,94,0.1);
            --blue: #5b8def;
            --blue-bg: rgba(91,141,239,0.1);
            --purple: #a78bfa;
            --sidebar-w: 260px;
        }

        html { scroll-behavior: smooth; }
        body { font-family: 'DM Sans', sans-serif; background: var(--dark); color: var(--text); min-height: 100vh; }
        body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 0; opacity: 0.4; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-w); height: 100vh; background: var(--dark-2); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; transform: translateX(-100%); transition: transform 0.3s ease; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid var(--border); }
        .sidebar-logo h1 { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; letter-spacing: 0.08em; }
        .sidebar-logo h1 span { color: var(--gold); }
        .sidebar-logo p { font-size: 10px; color: var(--text-muted); letter-spacing: 0.2em; text-transform: uppercase; margin-top: 4px; }
        .sidebar-nav { flex: 1; padding: 20px 12px; overflow-y: auto; }
        .nav-section { margin-bottom: 24px; }
        .nav-section-title { font-size: 10px; color: var(--text-muted); letter-spacing: 0.15em; text-transform: uppercase; padding: 0 12px; margin-bottom: 10px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-muted); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .nav-item:hover { background: var(--dark-3); color: var(--text); }
        .nav-item.active { background: var(--gold-dim); color: var(--gold); }
        .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
        .sidebar-footer { padding: 20px 16px; border-top: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 38px; height: 38px; background: var(--gold); display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 14px; color: var(--dark); flex-shrink: 0; }
        .user-name { font-size: 13px; font-weight: 600; }
        .user-email { font-size: 11px; color: var(--text-muted); }
        .btn-logout { margin-top: 12px; width: 100%; padding: 10px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .btn-logout:hover { border-color: var(--red); color: var(--red); background: var(--red-bg); }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; }
        .sidebar-overlay.show { display: block; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .main { min-height: 100vh; position: relative; z-index: 1; }
        .topbar { position: sticky; top: 0; z-index: 50; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(9,9,9,0.9); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); }
        .topbar-left { display: flex; align-items: center; gap: 16px; }
        .menu-toggle { background: none; border: 1px solid var(--border); color: var(--text); font-size: 18px; cursor: pointer; padding: 8px 12px; transition: all 0.2s; }
        .menu-toggle:hover { border-color: var(--gold); color: var(--gold); }
        .topbar h2 { font-size: 18px; font-weight: 600; }
        .topbar p { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .topbar-right { display: flex; gap: 12px; }
        .btn-home { font-size: 12px; color: var(--text-muted); text-decoration: none; padding: 8px 16px; border: 1px solid var(--border); transition: all 0.2s; }
        .btn-home:hover { color: var(--gold); border-color: var(--gold); }
        .content { padding: 20px; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BALANCE HERO ‚Äî REDISE√ëADO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .balance-hero { background: var(--dark-2); border: 1px solid var(--border); padding: 28px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .balance-hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold), var(--gold-light), transparent); }

        .balance-top-row { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 24px; }
        .balance-main { }
        .balance-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 6px; }
        .balance-amount { font-family: 'JetBrains Mono', monospace; font-size: 36px; font-weight: 700; color: var(--gold); line-height: 1.1; }
        .balance-currency { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .balance-breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .breakdown-card { background: var(--dark-3); border: 1px solid var(--border); padding: 18px; position: relative; overflow: hidden; }
        .breakdown-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; }
        .breakdown-card.available::before { background: var(--green); }
        .breakdown-card.invested::before { background: var(--blue); }
        .breakdown-icon { font-size: 16px; margin-bottom: 8px; display: block; }
        .breakdown-val { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 700; }
        .breakdown-val.green { color: var(--green); }
        .breakdown-val.blue { color: var(--blue); }
        .breakdown-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

        .balance-bar-container { margin-top: 20px; }
        .balance-bar-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.08em; }
        .balance-bar { height: 8px; background: var(--dark-3); display: flex; overflow: hidden; }
        .balance-bar-invested { height: 100%; background: var(--blue); transition: width 1s ease; }
        .balance-bar-available { height: 100%; background: var(--green); transition: width 1s ease; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--dark-2); border: 1px solid var(--border); padding: 20px; transition: all 0.2s; }
        .stat-card:hover { border-color: var(--border-hover); }
        .stat-icon { font-size: 20px; margin-bottom: 10px; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 700; }
        .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVESTMENT PRODUCTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .products-section { margin-bottom: 20px; }
        .products-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; }
        .products-title .badge-new { font-size: 9px; background: var(--gold); color: var(--dark); padding: 3px 8px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; }

        .product-card { background: linear-gradient(135deg, var(--dark-2) 0%, #131318 50%, var(--dark-2) 100%); border: 1px solid rgba(201,168,76,0.25); overflow: hidden; transition: all 0.4s; cursor: pointer; position: relative; }
        .product-card::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 30% 30%, rgba(201,168,76,0.06) 0%, transparent 60%); pointer-events: none; }
        .product-card:hover { border-color: var(--gold); box-shadow: 0 8px 32px rgba(201,168,76,0.15), inset 0 1px 0 rgba(201,168,76,0.1); transform: translateY(-2px); }
        .product-card-top { padding: 28px; position: relative; z-index: 1; }
        .product-card-top::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, transparent, var(--gold), var(--gold-light), var(--gold), transparent); }
        .product-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .product-name { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; }
        .product-badge { font-size: 10px; color: var(--green); background: var(--green-bg); padding: 4px 10px; font-weight: 600; letter-spacing: 0.05em; border: 1px solid rgba(78,203,141,0.2); }
        .product-rates { display: flex; gap: 16px; margin-bottom: 16px; }
        .product-rate { text-align: center; padding: 16px 20px; background: rgba(201,168,76,0.06); border: 1px solid rgba(201,168,76,0.15); flex: 1; position: relative; }
        .product-rate-val { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; color: var(--gold); text-shadow: 0 0 20px rgba(201,168,76,0.2); }
        .product-rate-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }
        .product-features { display: flex; flex-wrap: wrap; gap: 8px; }
        .product-feature { font-size: 11px; color: var(--text-muted); padding: 6px 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); transition: border-color 0.2s; }
        .product-feature:hover { border-color: rgba(201,168,76,0.3); }
        .product-cta { display: block; width: 100%; padding: 18px; text-align: center; background: linear-gradient(135deg, rgba(201,168,76,0.15), rgba(201,168,76,0.08)); color: var(--gold); font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; border: none; border-top: 1px solid rgba(201,168,76,0.2); cursor: pointer; transition: all 0.3s; position: relative; z-index: 1; }
        .product-cta:hover { background: var(--gold); color: var(--dark); letter-spacing: 0.15em; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVEST MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--dark-2); border: 1px solid var(--border); width: 90%; max-width: 500px; position: relative; overflow: hidden; max-height: 90vh; overflow-y: auto; }
        .modal::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold), var(--gold-light)); }
        .modal-header { padding: 24px 24px 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .modal-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; }
        .modal-close { background: none; border: 1px solid var(--border); color: var(--text-muted); width: 32px; height: 32px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .modal-close:hover { border-color: var(--red); color: var(--red); }
        .modal-body { padding: 24px; }
        .modal-info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .modal-info-row .label { color: var(--text-muted); }
        .modal-info-row .value { font-weight: 600; color: var(--text); }
        .modal-info-row .value.gold { color: var(--gold); }

        .invest-input-group { margin-top: 24px; }
        .invest-input-group label { display: block; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
        .invest-input-wrap { position: relative; }
        .invest-input-wrap .prefix { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px; }
        .invest-input { width: 100%; padding: 14px 14px 14px 28px; background: var(--dark-3); border: 1px solid var(--border); color: var(--text); font-family: 'JetBrains Mono', monospace; font-size: 18px; outline: none; transition: border 0.2s; }
        .invest-input:focus { border-color: var(--gold); }
        .invest-available { font-size: 12px; color: var(--text-muted); margin-top: 8px; }
        .invest-available span { color: var(--green); font-weight: 600; }

        .invest-preview { background: var(--dark-3); border: 1px solid var(--border); padding: 16px; margin-top: 20px; }
        .invest-preview-title { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; }
        .invest-preview-row { display: flex; justify-content: space-between; font-size: 13px; padding: 8px 0; }
        .invest-preview-row .label { color: var(--text-muted); }
        .invest-preview-row .value { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
        .invest-preview-row .value.green { color: var(--green); }

        .btn-invest { width: 100%; padding: 16px; margin-top: 20px; background: var(--gold); border: none; color: var(--dark); font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-invest:hover { background: var(--gold-light); transform: translateY(-1px); }
        .btn-invest:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .invest-disclaimer { font-size: 10px; color: var(--text-muted); margin-top: 12px; line-height: 1.6; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVESTMENT ACTION BUTTONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .inv-actions { display: flex; gap: 12px; margin-top: 20px; }
        .btn-add-capital { padding: 12px 24px; background: var(--blue); border: none; color: white; font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-add-capital:hover { background: #4a7de0; transform: translateY(-1px); }
        .btn-withdraw { padding: 12px 24px; background: transparent; border: 1px solid var(--green); color: var(--green); font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-withdraw:hover:not(:disabled) { background: var(--green); color: var(--dark); transform: translateY(-1px); }
        .btn-withdraw:disabled { opacity: 0.35; cursor: not-allowed; border-color: var(--border); color: var(--text-muted); transform: none; }
        .btn-withdraw:disabled:hover { background: transparent; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MY INVESTMENTS LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .my-investments { margin-bottom: 20px; }
        .inv-list-title { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700; margin-bottom: 14px; }
        .inv-card { background: var(--dark-2); border: 1px solid var(--border); padding: 20px; margin-bottom: 12px; cursor: pointer; transition: border-color 0.3s; }
        .inv-card:hover { border-color: var(--border-hover); }
        .inv-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .inv-card-type { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .inv-card-status { font-size: 10px; padding: 3px 10px; font-weight: 600; }
        .inv-card-status.active { color: var(--green); background: var(--green-bg); }
        .inv-card-status.completed { color: var(--blue); background: var(--blue-bg); }
        .inv-card-status.pending_deposit { color: #f59e0b; background: rgba(245,158,11,0.1); }
        .inv-card-body { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 14px; }
        .inv-card-stat { }
        .inv-card-stat-val { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 600; }
        .inv-card-stat-val.gold { color: var(--gold); }
        .inv-card-stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }
        .inv-progress-bar { height: 4px; background: var(--dark-3); overflow: hidden; margin-top: 4px; }
        .inv-progress-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--gold-light)); transition: width 1s ease; }
        .inv-progress-info { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-top: 6px; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVESTMENT DETAIL PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .detail-panel { display: none; }
        .detail-panel.open { display: block; }
        .detail-back { background: none; border: none; color: var(--gold); cursor: pointer; font-size: 13px; font-family: 'DM Sans', sans-serif; margin-bottom: 16px; padding: 0; }
        .detail-back:hover { text-decoration: underline; }
        .detail-hero { background: var(--dark-2); border: 1px solid var(--border); padding: 28px; margin-bottom: 16px; position: relative; overflow: hidden; }
        .detail-hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--gold), var(--gold-light)); }
        .detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 20px; }
        .detail-stat { text-align: center; }
        .detail-stat-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; }
        .detail-stat-val.gold { color: var(--gold); }
        .detail-stat-val.green { color: var(--green); }
        .detail-stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

        .returns-table { background: var(--dark-2); border: 1px solid var(--border); overflow: hidden; margin-bottom: 16px; }
        .returns-table-header { padding: 16px 20px; border-bottom: 1px solid var(--border); font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
        .returns-table table { width: 100%; border-collapse: collapse; }
        .returns-table th { text-align: left; padding: 12px 16px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid var(--border); font-weight: 500; }
        .returns-table td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid var(--border); }
        .returns-table tr:last-child td { border-bottom: none; }
        .returns-table tr:hover td { background: var(--gold-dim); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHART & TABLES (existing) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .chart-card { background: var(--dark-2); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 14px; font-weight: 600; }
        .chart-subtitle { font-size: 11px; color: var(--text-muted); }
        .chart-container { position: relative; height: 180px; }
        .chart-svg { width: 100%; height: 100%; }

        .table-card { background: var(--dark-2); border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
        .table-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .table-title { font-size: 14px; font-weight: 600; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 12px 16px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid var(--border); font-weight: 500; }
        .data-table td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid var(--border); }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: var(--gold-dim); }
        .badge { display: inline-flex; padding: 4px 10px; font-size: 10px; font-weight: 600; letter-spacing: 0.05em; }
        .badge-deposit { color: var(--green); background: var(--green-bg); }
        .badge-profit { color: var(--gold); background: var(--gold-dim); }
        .badge-withdraw { color: var(--red); background: var(--red-bg); }
        .badge-investment { color: var(--blue); background: var(--blue-bg); }
        .amount-positive { color: var(--green); font-family: 'JetBrains Mono', monospace; }
        .amount-negative { color: var(--red); font-family: 'JetBrains Mono', monospace; }
        .amount-neutral { font-family: 'JetBrains Mono', monospace; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADING / ERROR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .loading-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: var(--text-muted); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-state { background: var(--red-bg); border: 1px solid rgba(231,76,94,0.2); padding: 32px; text-align: center; color: var(--red); }
        .error-state button { margin-top: 16px; padding: 10px 24px; background: var(--red); color: white; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 600; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 24px; border-radius: 0; font-size: 13px; font-weight: 600; z-index: 999; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast-success { background: var(--green); color: var(--dark); }
        .toast-error { background: var(--red); color: white; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        @media (min-width: 480px) {
            .content { padding: 24px; }
            .balance-amount { font-size: 44px; }
        }
        @media (min-width: 768px) {
            .sidebar { transform: translateX(0); }
            .main { margin-left: var(--sidebar-w); }
            .menu-toggle { display: none; }
            .topbar { padding: 20px 32px; }
            .content { padding: 32px; }
            .balance-hero { padding: 32px; }
            .balance-amount { font-size: 48px; }
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .inv-card-body { grid-template-columns: repeat(4, 1fr); }
            .detail-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .inv-card-body { grid-template-columns: repeat(2, 1fr); }
            .detail-grid { grid-template-columns: repeat(2, 1fr); }
            .product-rates { flex-direction: column; }
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        .delay-3 { animation-delay: 0.3s; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); }
    </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-logo"><h1>SANSE <span>CAPITAL</span></h1><p>Panel de Control</p></div>
    <nav class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Principal</div>
            <a class="nav-item active" href="#" onclick="showView('dashboard')"><span class="icon">üìä</span> Dashboard</a>
            <a class="nav-item" href="#" onclick="showView('investments')"><span class="icon">üí∞</span> Inversiones</a>
            <a class="nav-item" href="#" onclick="showView('withdraw')"><span class="icon">üì§</span> Retirar</a>
            <a class="nav-item" href="#" onclick="showView('movements')"><span class="icon">üìã</span> Movimientos</a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">M√°s</div>
            <a class="nav-item" href="https://wa.me/573194552890" target="_blank"><span class="icon">üí¨</span> Soporte</a>
        </div>
    </nav>
    <div class="sidebar-footer">
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">--</div>
            <div><div class="user-name" id="user-name">Cargando...</div><div class="user-email" id="user-email">...</div></div>
        </div>
        <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
</aside>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Main -->
<main class="main">
    <div class="topbar">
        <div class="topbar-left">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <div><h2 id="greeting">Cargando...</h2><p id="date-display"></p></div>
        </div>
        <div class="topbar-right"><a href="index.html" class="btn-home">‚Üê Ir al Home</a></div>
    </div>

    <div class="content" id="dashboard-content">
        <div class="loading-state"><div class="loading-spinner"></div><p>Cargando tu informaci√≥n...</p></div>
    </div>
</main>

<!-- Invest Modal -->
<div class="modal-overlay" id="investModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">üí∞ Invertir en SDTC</div>
            <button class="modal-close" onclick="closeInvestModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="invest-active-warning" style="display:none;"></div>
            <div class="modal-info-row"><span class="label">Producto</span><span class="value">Inversi√≥n SDTC</span></div>
            <div class="modal-info-row"><span class="label">Plazo</span><span class="value">6 meses</span></div>
            <div class="modal-info-row"><span class="label">Rendimiento mensual</span><span class="value gold">2% ‚Äî 4% variable</span></div>
            <div class="modal-info-row"><span class="label">Monto m√≠nimo</span><span class="value">$100.000 COP</span></div>

            <div class="invest-input-group">
                <label>Monto a invertir (COP)</label>
                <div class="invest-input-wrap">
                    <span class="prefix">$</span>
                    <input type="number" class="invest-input" id="invest-amount" placeholder="0" min="100000" oninput="updateInvestPreview()">
                </div>
                <div class="invest-available">Disponible: <span id="invest-available-display">$0</span></div>
            </div>

            <div class="invest-preview" id="invest-preview" style="display:none;">
                <div class="invest-preview-title">üìã Resumen de tu inversi√≥n</div>
                <div class="invest-preview-row"><span class="label">Capital</span><span class="value" id="preview-capital">$0</span></div>
                <div class="invest-preview-row"><span class="label">Desbloqueo estimado</span><span class="value" id="preview-unlock">‚Äî</span></div>
                <div class="invest-preview-row"><span class="label">Ganancia m√≠n. estimada (6m)</span><span class="value green" id="preview-min-gain">$0</span></div>
                <div class="invest-preview-row"><span class="label">Ganancia m√°x. estimada (6m)</span><span class="value green" id="preview-max-gain">$0</span></div>
            </div>

            <button class="btn-invest" id="btn-invest" onclick="executeInvestment()" disabled>Confirmar Inversi√≥n ‚Üí</button>
            <p class="invest-disclaimer">‚ö†Ô∏è El capital quedar√° bloqueado por 6 meses. Los rendimientos son variables y no garantizados. Al confirmar, aceptas los T√©rminos y Condiciones.</p>
        </div>
    </div>
</div>

<!-- Add Capital Modal -->
<div class="modal-overlay" id="addCapitalModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">‚ûï Invertir M√°s Capital</div>
            <button class="modal-close" onclick="closeAddCapitalModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="modal-info-row"><span class="label">Inversi√≥n</span><span class="value" id="ac-inv-label">SDTC #‚Äî</span></div>
            <div class="modal-info-row"><span class="label">Capital Actual</span><span class="value gold" id="ac-current">$0</span></div>
            <div class="modal-info-row"><span class="label">Fecha de Vencimiento</span><span class="value" id="ac-lock-date">‚Äî</span></div>
            <div style="background:var(--blue-bg);border:1px solid rgba(91,141,239,0.2);padding:12px 16px;margin-top:16px;font-size:12px;color:var(--blue);">
                ‚ÑπÔ∏è El capital adicional se suma al contrato actual. La fecha de vencimiento <strong>no cambia</strong>.
            </div>

            <div class="invest-input-group">
                <label>Monto a agregar (COP)</label>
                <div class="invest-input-wrap">
                    <span class="prefix">$</span>
                    <input type="number" class="invest-input" id="ac-amount" placeholder="0" min="50000" oninput="updateAddCapitalPreview()">
                </div>
                <div class="invest-available">Disponible: <span id="ac-available-display">$0</span> ¬∑ M√≠nimo: $50.000</div>
            </div>

            <div class="invest-preview" id="ac-preview" style="display:none;">
                <div class="invest-preview-title">üìã Resumen</div>
                <div class="invest-preview-row"><span class="label">Capital actual</span><span class="value" id="acp-current">$0</span></div>
                <div class="invest-preview-row"><span class="label">+ Capital adicional</span><span class="value" style="color:var(--blue)" id="acp-added">$0</span></div>
                <div class="invest-preview-row" style="border-top:1px solid var(--border);padding-top:12px;"><span class="label">Nuevo capital total</span><span class="value gold" id="acp-new-total">$0</span></div>
            </div>

            <button class="btn-invest" id="btn-add-capital-confirm" onclick="executeAddCapital()" disabled style="background:var(--blue);">Confirmar Capital Adicional ‚Üí</button>
            <p class="invest-disclaimer">‚ö†Ô∏è La fecha de vencimiento permanece igual. Los rendimientos futuros se calcular√°n sobre el nuevo capital total.</p>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
    const API_URL = 'https://sanse-backend-production.up.railway.app/api';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getToken() { return localStorage.getItem('sanse_access_token') || sessionStorage.getItem('sanse_access_token'); }
    function getRefreshToken() { return localStorage.getItem('sanse_refresh_token') || sessionStorage.getItem('sanse_refresh_token'); }
    function getUserData() { const d = localStorage.getItem('sanse_user') || sessionStorage.getItem('sanse_user'); return d ? JSON.parse(d) : null; }
    function getStorage() { return localStorage.getItem('sanse_access_token') ? localStorage : sessionStorage; }
    if (!getToken()) window.location.href = 'login.html';

    async function apiFetch(endpoint, options = {}) {
        const token = getToken();
        const config = { ...options, headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}`, ...options.headers } };
        let res = await fetch(`${API_URL}${endpoint}`, config);
        if (res.status === 401) {
            const ok = await refreshAccessToken();
            if (ok) { config.headers['Authorization'] = `Bearer ${getToken()}`; res = await fetch(`${API_URL}${endpoint}`, config); }
            else { logout(); return null; }
        }
        return res;
    }

    async function refreshAccessToken() {
        try {
            const rt = getRefreshToken(); if (!rt) return false;
            const res = await fetch(`${API_URL}/auth/refresh`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({refreshToken:rt}) });
            if (!res.ok) return false;
            const data = await res.json();
            const s = getStorage();
            s.setItem('sanse_access_token', data.accessToken);
            s.setItem('sanse_refresh_token', data.refreshToken);
            return true;
        } catch { return false; }
    }

    function logout() {
        ['sanse_access_token','sanse_refresh_token','sanse_user'].forEach(k => { localStorage.removeItem(k); sessionStorage.removeItem(k); });
        window.location.href = 'login.html';
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('show'); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function formatCOP(n) { return '$' + Math.round(n).toLocaleString('es-CO'); }
    function formatDate(d) { return new Date(d).toLocaleDateString('es-CO', { day:'numeric', month:'short', year:'numeric' }); }
    function toast(msg, type='success') { const el = document.getElementById('toast'); el.textContent = msg; el.className = `toast toast-${type} show`; setTimeout(() => el.classList.remove('show'), 3500); }

    function setGreeting(userName) {
        const h = new Date().getHours();
        let g = h >= 5 && h < 12 ? 'Buenos d√≠as' : h >= 12 && h < 19 ? 'Buenas tardes' : 'Buenas noches';
        const firstName = userName ? userName.split(' ')[0] : '';
        document.getElementById('greeting').textContent = `${g}, ${firstName}`;
        document.getElementById('date-display').textContent = new Date().toLocaleDateString('es-CO', { weekday:'long', day:'numeric', month:'short' });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let dashboardData = null;
    let balanceSummary = { totalBalance: 0, totalInvested: 0, availableBalance: 0, totalEarnings: 0 };
    let myInvestments = [];
    let currentView = 'dashboard';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIEWS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showView(view) {
        currentView = view;
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        event?.target?.closest('.nav-item')?.classList.add('active');
        renderCurrentView();
    }

    function renderCurrentView() {
        const content = document.getElementById('dashboard-content');
        if (currentView === 'dashboard') renderDashboard(content);
        else if (currentView === 'investments') renderInvestmentsView(content);
        else if (currentView === 'movements') renderMovementsView(content);
        else if (currentView === 'withdraw') renderWithdrawView(content);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderDashboard(container) {
        if (!dashboardData) return;
        const d = dashboardData;
        const b = balanceSummary;
        const investedPct = b.totalBalance > 0 ? Math.round((b.totalInvested / b.totalBalance) * 100) : 0;
        const availablePct = 100 - investedPct;

        container.innerHTML = `
        <!-- Balance Hero -->
        <div class="balance-hero animate-in">
            <div class="balance-top-row">
                <div class="balance-main">
                    <div class="balance-label">üí∞ Tu Saldo Total</div>
                    <div class="balance-amount">${formatCOP(b.totalBalance)}</div>
                    <div class="balance-currency">Pesos Colombianos (COP)</div>
                </div>
            </div>

            <div class="balance-breakdown">
                <div class="breakdown-card available">
                    <span class="breakdown-icon">üü¢</span>
                    <div class="breakdown-val green">${formatCOP(b.availableBalance)}</div>
                    <div class="breakdown-label">Disponible para invertir</div>
                </div>
                <div class="breakdown-card invested">
                    <span class="breakdown-icon">üîµ</span>
                    <div class="breakdown-val blue">${formatCOP(b.totalInvested)}</div>
                    <div class="breakdown-label">En inversiones activas</div>
                </div>
                ${b.pendingWithdrawals > 0 ? `
                <div class="breakdown-card" style="border-color:rgba(245,158,11,0.3);">
                    <span class="breakdown-icon">‚è≥</span>
                    <div class="breakdown-val" style="color:#f59e0b;">${formatCOP(b.pendingWithdrawals)}</div>
                    <div class="breakdown-label">En retiros pendientes</div>
                </div>` : ''}
            </div>

            <div class="balance-bar-container">
                <div class="balance-bar-labels">
                    <span>Invertido ${investedPct}%</span>
                    <span>Disponible ${availablePct}%</span>
                </div>
                <div class="balance-bar">
                    <div class="balance-bar-invested" style="width:${investedPct}%"></div>
                    <div class="balance-bar-available" style="width:${availablePct}%"></div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid animate-in delay-1">
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value" style="color:var(--green)">+${formatCOP(b.totalEarnings)}</div>
                <div class="stat-label">Rendimientos Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value">${d.monthsInvesting}</div>
                <div class="stat-label">Meses Invirtiendo</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíé</div>
                <div class="stat-value">${myInvestments.filter(i => i.status === 'active').length}</div>
                <div class="stat-label">Inversiones Activas</div>
            </div>
        </div>

        <!-- Product Card -->
        <div class="products-section animate-in delay-2">
            <div class="products-title">Productos de Inversi√≥n <span class="badge-new">Nuevo</span></div>
            <div class="product-card" onclick="openInvestModal()">
                <div class="product-card-top">
                    <div class="product-header">
                        <div>
                            <div class="product-name">Inversi√≥n SDTC</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Certificado de Dep√≥sito a T√©rmino ‚Äî Sanse Capital</div>
                        </div>
                        <span class="product-badge">${myInvestments.filter(i => ['active','pending_deposit'].includes(i.status)).length}/3 Activas</span>
                    </div>
                    <div class="product-rates">
                        <div class="product-rate">
                            <div class="product-rate-val">2% ‚Äî 4%</div>
                            <div class="product-rate-label">Rendimiento Mensual</div>
                        </div>
                        <div class="product-rate">
                            <div class="product-rate-val">6</div>
                            <div class="product-rate-label">Meses de Plazo</div>
                        </div>
                        <div class="product-rate">
                            <div class="product-rate-val">$100K</div>
                            <div class="product-rate-label">Inversi√≥n M√≠nima</div>
                        </div>
                    </div>
                    <div class="product-features">
                        <span class="product-feature">üìÖ Plazo fijo 6 meses</span>
                        <span class="product-feature">üìà Rendimiento variable</span>
                        <span class="product-feature">üîí Capital bloqueado</span>
                        <span class="product-feature">‚è±Ô∏è 12h para cancelar</span>
                        <span class="product-feature">üîÑ M√°x. 3 activas</span>
                    </div>
                </div>
                <button class="product-cta">${myInvestments.filter(i => ['active','pending_deposit'].includes(i.status)).length >= 3 ? 'üîí L√≠mite Alcanzado (3/3)' : '‚ú® Invertir Ahora ‚Üí'}</button>
            </div>
        </div>

        <!-- Active Investments -->
        ${myInvestments.filter(i => i.status === 'active' || i.status === 'pending_deposit').length > 0 ? `
        <div class="my-investments animate-in delay-3">
            <div class="inv-list-title">üìä Mis Inversiones Activas</div>
            ${myInvestments.filter(i => i.status === 'active' || i.status === 'pending_deposit').map(inv => `
                <div class="inv-card" onclick="showInvestmentDetail(${inv.id})">
                    <div class="inv-card-header">
                        <span class="inv-card-type">üí∞ ${inv.type} <span style="font-size:12px;color:var(--text-muted);font-weight:400;">‚Äî ${inv.durationMonths || 6} meses</span></span>
                        <span class="inv-card-status ${inv.status}">${inv.status === 'pending_deposit' ? '‚è≥ En dep√≥sito' : 'Activa'}</span>
                    </div>
                    ${inv.status === 'pending_deposit' ? `<div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);padding:10px 14px;margin-bottom:12px;font-size:11px;color:#f59e0b;">‚è±Ô∏è Per√≠odo de dep√≥sito ‚Äî Puedes cancelar en las pr√≥ximas horas. <strong>Haz clic para ver opciones.</strong></div>` : ''}
                    <div class="inv-card-body">
                        <div class="inv-card-stat"><div class="inv-card-stat-val gold">${formatCOP(inv.amount)}</div><div class="inv-card-stat-label">Capital</div></div>
                        <div class="inv-card-stat"><div class="inv-card-stat-val">${inv.minMonthlyRate}%-${inv.maxMonthlyRate}%</div><div class="inv-card-stat-label">Tasa Mensual</div></div>
                        <div class="inv-card-stat"><div class="inv-card-stat-val" style="color:var(--green)">+${formatCOP(inv.totalEarned)}</div><div class="inv-card-stat-label">Ganado</div></div>
                        <div class="inv-card-stat"><div class="inv-card-stat-val">${inv.daysRemaining}d</div><div class="inv-card-stat-label">Restantes</div></div>
                    </div>
                    <div class="inv-progress-bar"><div class="inv-progress-fill" style="width:${inv.progressPct}%"></div></div>
                    <div class="inv-progress-info"><span>${formatDate(inv.startDate)}</span><span>${inv.progressPct}% completado</span><span>üîì ${formatDate(inv.lockEndDate || inv.endDate)}</span></div>
                </div>
            `).join('')}
        </div>` : ''}

        <!-- Chart & Transactions -->
        <div class="grid-2 animate-in delay-3">
            <div class="chart-card">
                <div class="chart-header"><div><div class="chart-title">Crecimiento</div><div class="chart-subtitle">Historial de saldo</div></div></div>
                <div class="chart-container"><svg class="chart-svg" id="chart-svg" viewBox="0 0 500 200" preserveAspectRatio="none"></svg></div>
            </div>
            <div class="table-card">
                <div class="table-header"><span class="table-title">√öltimos Movimientos</span></div>
                <table class="data-table">
                    <thead><tr><th>Fecha</th><th>Tipo</th><th style="text-align:right">Monto</th></tr></thead>
                    <tbody>${d.transactions.slice(0, 8).map(tx => {
                        const typeLabels = { deposit:'Dep√≥sito', profit:'Rendimiento', withdraw:'Retiro', payment:'Abono', interest:'Intereses', investment:'Inversi√≥n', investment_return:'Rendimiento SDTC', investment_withdrawal:'Retiro SDTC', loan:'Pr√©stamo' };
                        const badgeClass = { deposit:'badge-deposit', profit:'badge-profit', withdraw:'badge-withdraw', investment:'badge-investment', investment_return:'badge-deposit', investment_withdrawal:'badge-profit' };
                        const isNeg = tx.type === 'withdraw' || tx.type === 'investment';
                        return `<tr>
                            <td style="color:var(--text-muted)">${formatDate(tx.date)}</td>
                            <td><span class="badge ${badgeClass[tx.type] || 'badge-deposit'}">${typeLabels[tx.type] || tx.type}</span></td>
                            <td class="${isNeg ? 'amount-negative' : 'amount-positive'}" style="text-align:right">${isNeg ? '-' : '+'}${formatCOP(tx.amount)}</td>
                        </tr>`;
                    }).join('')}</tbody>
                </table>
            </div>
        </div>`;

        // Draw chart
        setTimeout(() => drawChart(d.balanceHistory), 100);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER INVESTMENTS VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderInvestmentsView(container) {
        const activeCount = myInvestments.filter(i => ['active','pending_deposit'].includes(i.status)).length;
        container.innerHTML = `
        <div class="products-section animate-in">
            <div class="products-title">üí∞ Productos Disponibles</div>
            <div class="product-card" onclick="${activeCount >= 3 ? '' : 'openInvestModal()'}">
                <div class="product-card-top">
                    <div class="product-header">
                        <div>
                            <div class="product-name">Inversi√≥n SDTC</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Certificado de Dep√≥sito a T√©rmino ‚Äî Sanse Capital</div>
                        </div>
                        <span class="product-badge">${activeCount}/3 Activas</span>
                    </div>
                    <div class="product-rates">
                        <div class="product-rate"><div class="product-rate-val">2% ‚Äî 4%</div><div class="product-rate-label">Rendimiento Mensual</div></div>
                        <div class="product-rate"><div class="product-rate-val">6</div><div class="product-rate-label">Meses de Plazo</div></div>
                        <div class="product-rate"><div class="product-rate-val">$100K</div><div class="product-rate-label">Inversi√≥n M√≠nima</div></div>
                    </div>
                    <div class="product-features">
                        <span class="product-feature">üìÖ Plazo fijo 6 meses</span>
                        <span class="product-feature">üìà Rendimiento variable</span>
                        <span class="product-feature">üîí Capital bloqueado</span>
                        <span class="product-feature">‚è±Ô∏è 12h para cancelar</span>
                        <span class="product-feature">üîÑ M√°x. 3 activas</span>
                    </div>
                </div>
                <button class="product-cta">${activeCount >= 3 ? 'üîí L√≠mite Alcanzado (3/3)' : '‚ú® Invertir Ahora ‚Üí'}</button>
            </div>
        </div>

        <div class="my-investments animate-in delay-1">
            <div class="inv-list-title">üìä Todas Mis Inversiones</div>
            <div id="all-investments-list"></div>
        </div>

        <div class="detail-panel" id="investment-detail-panel"></div>`;

        const list = document.getElementById('all-investments-list');
        if (!myInvestments.length) {
            list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">A√∫n no tienes inversiones. ¬°Comienza invirtiendo arriba!</div>';
        } else {
            list.innerHTML = myInvestments.map(inv => `
                <div class="inv-card" onclick="showInvestmentDetail(${inv.id})">
                    <div class="inv-card-header">
                        <span class="inv-card-type">üí∞ ${inv.type} <span style="font-size:12px;color:var(--text-muted);font-weight:400;">‚Äî ${inv.durationMonths || 6} meses</span></span>
                        <span class="inv-card-status ${inv.status}">${inv.status === 'pending_deposit' ? '‚è≥ En dep√≥sito' : inv.status === 'active' ? 'Activa' : inv.status === 'completed' ? 'Completada' : inv.status}</span>
                    </div>
                    ${inv.isPendingDeposit ? `<div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);padding:8px 12px;margin-bottom:10px;font-size:11px;color:#f59e0b;">‚è±Ô∏è Per√≠odo de dep√≥sito. Haz clic para cancelar o confirmar.</div>` : ''}
                    <div class="inv-card-body">
                        <div class="inv-card-stat"><div class="inv-card-stat-val gold">${formatCOP(inv.amount)}</div><div class="inv-card-stat-label">Capital</div></div>
                        <div class="inv-card-stat"><div class="inv-card-stat-val">${inv.minMonthlyRate}%-${inv.maxMonthlyRate}%</div><div class="inv-card-stat-label">Tasa</div></div>
                        <div class="inv-card-stat"><div class="inv-card-stat-val" style="color:var(--green)">+${formatCOP(inv.totalEarned)}</div><div class="inv-card-stat-label">Ganado</div></div>
                        <div class="inv-card-stat"><div class="inv-card-stat-val">${inv.daysRemaining}d</div><div class="inv-card-stat-label">Restantes</div></div>
                    </div>
                    <div class="inv-progress-bar"><div class="inv-progress-fill" style="width:${inv.progressPct}%"></div></div>
                    <div class="inv-progress-info"><span>${formatDate(inv.startDate)}</span><span>${inv.progressPct}%</span><span>üîì ${formatDate(inv.lockEndDate || inv.endDate)}</span></div>
                </div>
            `).join('');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER MOVEMENTS VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderMovementsView(container) {
        if (!dashboardData) return;
        container.innerHTML = `
        <div class="table-card animate-in">
            <div class="table-header"><span class="table-title">üìã Todos los Movimientos</span></div>
            <table class="data-table">
                <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Tipo</th><th style="text-align:right">Monto</th></tr></thead>
                <tbody>${dashboardData.transactions.map(tx => {
                    const typeLabels = { deposit:'Dep√≥sito', profit:'Rendimiento', withdraw:'Retiro', payment:'Abono', interest:'Intereses', investment:'Inversi√≥n', investment_return:'Rendimiento SDTC', investment_withdrawal:'Retiro SDTC', loan:'Pr√©stamo' };
                    const badgeClass = { deposit:'badge-deposit', profit:'badge-profit', withdraw:'badge-withdraw', investment:'badge-investment', investment_return:'badge-deposit', investment_withdrawal:'badge-profit' };
                    const isNeg = tx.type === 'withdraw' || tx.type === 'investment';
                    return `<tr>
                        <td style="color:var(--text-muted)">${formatDate(tx.date)}</td>
                        <td>${tx.description || '-'}</td>
                        <td><span class="badge ${badgeClass[tx.type] || 'badge-deposit'}">${typeLabels[tx.type] || tx.type}</span></td>
                        <td class="${isNeg ? 'amount-negative' : 'amount-positive'}" style="text-align:right">${isNeg ? '-' : '+'}${formatCOP(tx.amount)}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table>
        </div>`;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVESTMENT DETAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function showInvestmentDetail(invId) {
        try {
            const res = await apiFetch(`/investments/${invId}`);
            if (!res || !res.ok) { toast('Error cargando detalle', 'error'); return; }
            const data = await res.json();
            const inv = data.investment;
            const returns = data.returns;

            const now = new Date();
            const end = new Date(inv.lockEndDate || inv.endDate);
            const start = new Date(inv.startDate);
            const totalDays = Math.max(1, (end - start) / (1000*60*60*24));
            const elapsed = Math.max(0, (now - start) / (1000*60*60*24));
            const pct = Math.min(100, Math.round((elapsed / totalDays) * 100));
            const daysLeft = Math.max(0, Math.ceil((end - now) / (1000*60*60*24)));
            const totalEarned = returns.reduce((s, r) => s + r.earned, 0);
            const isMatured = inv.isMatured || now >= end;
            const isActive = inv.status === 'active';
            const isPendingDeposit = inv.status === 'pending_deposit';

            // Store for add-capital modal
            window._currentDetailInv = { id: invId, amount: inv.amount, lockEndDate: inv.lockEndDate || inv.endDate, type: inv.type };

            const content = document.getElementById('dashboard-content');
            content.innerHTML = `
            <button class="detail-back" onclick="showView('${currentView === 'investments' ? 'investments' : 'dashboard'}')">‚Üê Volver</button>

            <div class="detail-hero animate-in">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:4px;">Inversi√≥n ${inv.type}</div>
                        <div style="font-family:'Syne',sans-serif;font-size:32px;font-weight:800;color:var(--gold);">${formatCOP(inv.amount)}</div>
                    </div>
                    <span class="inv-card-status ${inv.status}" style="font-size:12px;padding:6px 14px;">${inv.status === 'active' ? 'üü¢ Activa' : inv.status === 'pending_deposit' ? '‚è≥ En dep√≥sito' : '‚úÖ Completada'}</span>
                </div>

                <div class="detail-grid">
                    <div class="detail-stat"><div class="detail-stat-val">${formatDate(inv.startDate)}</div><div class="detail-stat-label">Fecha Inicio</div></div>
                    <div class="detail-stat"><div class="detail-stat-val">${formatDate(inv.lockEndDate || inv.endDate)}</div><div class="detail-stat-label">Desbloqueo</div></div>
                    <div class="detail-stat"><div class="detail-stat-val green">+${formatCOP(totalEarned)}</div><div class="detail-stat-label">Rendimiento Acumulado</div></div>
                    <div class="detail-stat"><div class="detail-stat-val">${daysLeft} d√≠as</div><div class="detail-stat-label">Restantes</div></div>
                </div>

                <div style="margin-top:20px;">
                    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.08em;">
                        <span>Progreso</span><span>${pct}%</span>
                    </div>
                    <div class="inv-progress-bar" style="height:6px;"><div class="inv-progress-fill" style="width:${pct}%"></div></div>
                </div>

                ${isPendingDeposit ? `
                <div style="margin-top:20px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);padding:20px;">
                    <div style="font-weight:700;color:#f59e0b;margin-bottom:8px;font-size:14px;">‚è±Ô∏è Per√≠odo de Dep√≥sito (12 horas)</div>
                    <div style="font-size:12px;color:var(--text-muted);line-height:1.6;margin-bottom:16px;">
                        Tu inversi√≥n est√° en per√≠odo de dep√≥sito. Puedes <strong style="color:var(--text)">cancelarla sin costo</strong> dentro de las pr√≥ximas horas, o <strong style="color:var(--green)">confirmarla</strong> para activarla inmediatamente.
                    </div>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;">
                        <button onclick="confirmPendingInvestment(${invId})" style="padding:12px 24px;background:var(--green);border:none;color:var(--dark);font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;">‚úÖ Confirmar Inversi√≥n</button>
                        <button onclick="cancelPendingInvestment(${invId})" style="padding:12px 24px;background:transparent;border:1px solid var(--red);color:var(--red);font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;">‚ùå Cancelar Inversi√≥n</button>
                    </div>
                </div>
                ` : isActive ? `
                <div class="inv-actions">
                    ${!isMatured ? `<button class="btn-add-capital" onclick="openAddCapitalModal()">‚ûï Invertir M√°s</button>` : ''}
                    <button class="btn-withdraw" ${!isMatured ? 'disabled title="Disponible cuando venza el plazo el ' + formatDate(inv.lockEndDate || inv.endDate) + '"' : `onclick="withdrawInvestment(${invId})"`}>
                        ${isMatured ? 'üí∞ Retirar Inversi√≥n' : 'üîí Retirar (Bloqueado)'}
                    </button>
                    ${!isMatured ? `<span style="font-size:11px;color:var(--text-muted);align-self:center;">Retiro disponible el ${formatDate(inv.lockEndDate || inv.endDate)}</span>` : `<span style="font-size:11px;color:var(--green);align-self:center;">‚úÖ Tu inversi√≥n ha vencido. Ya puedes retirar.</span>`}
                </div>
                ` : `<div style="margin-top:20px;padding:12px 16px;background:var(--blue-bg);border:1px solid rgba(91,141,239,0.2);font-size:12px;color:var(--blue);">‚úÖ Esta inversi√≥n fue completada y el capital fue devuelto a tu saldo disponible.</div>`}
            </div>

            <div class="returns-table animate-in delay-1">
                <div class="returns-table-header">üìà Historial de Rendimientos Mensuales</div>
                ${returns.length > 0 ? `
                <table>
                    <thead><tr><th>Mes</th><th>Tasa Aplicada</th><th>Rendimiento</th><th>Estado</th></tr></thead>
                    <tbody>${returns.map(r => `
                        <tr>
                            <td>${formatDate(r.month)}</td>
                            <td style="color:var(--gold);font-weight:600;">${r.rate}%</td>
                            <td style="color:var(--green);font-family:'JetBrains Mono',monospace;">+${formatCOP(r.earned)}</td>
                            <td><span class="badge ${r.status === 'paid' ? 'badge-deposit' : 'badge-profit'}">${r.status === 'paid' ? 'Pagado' : r.status === 'reinvested' ? 'Reinvertido' : 'Pendiente'}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>` : `<div style="padding:40px;text-align:center;color:var(--text-muted);">A√∫n no hay rendimientos registrados. Se actualizan mensualmente.</div>`}
            </div>

            ${data.transactions.length > 0 ? `
            <div class="table-card animate-in delay-2">
                <div class="table-header"><span class="table-title">üìã Movimientos de esta Inversi√≥n</span></div>
                <table class="data-table">
                    <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Ref</th><th style="text-align:right">Monto</th></tr></thead>
                    <tbody>${data.transactions.map(t => `
                        <tr>
                            <td style="color:var(--text-muted)">${formatDate(t.date)}</td>
                            <td>${t.description || '-'}</td>
                            <td style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-muted)">${t.refId || '-'}</td>
                            <td style="text-align:right;font-family:'JetBrains Mono',monospace;">${formatCOP(t.amount)}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            </div>` : ''}`;
        } catch (e) {
            console.error(e);
            toast('Error cargando detalle de inversi√≥n', 'error');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INVEST MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openInvestModal() {
        // Check max 3 active
        const activeCount = myInvestments.filter(i => ['active','pending_deposit'].includes(i.status)).length;
        if (activeCount >= 3) {
            toast('Ya tienes 3 inversiones SDTC activas. Espera a que una termine o ret√≠rala.', 'error');
            return;
        }

        // Check if user already has an active SDTC
        const activeSDTC = myInvestments.find(i => i.status === 'active' && i.type === 'SDTC');
        
        if (activeSDTC) {
            // Show warning with option to add capital instead
            const warningEl = document.getElementById('invest-active-warning');
            if (warningEl) {
                warningEl.style.display = 'block';
                warningEl.innerHTML = `
                    <div style="background:rgba(91,141,239,0.1);border:1px solid rgba(91,141,239,0.3);padding:16px;margin-bottom:16px;">
                        <div style="font-weight:700;color:var(--blue);margin-bottom:8px;">‚ö†Ô∏è Ya tienes una inversi√≥n SDTC activa</div>
                        <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
                            Tu inversi√≥n actual de <strong style="color:var(--gold)">${formatCOP(activeSDTC.amount)}</strong> vence el <strong>${formatDate(activeSDTC.lockEndDate || activeSDTC.endDate)}</strong>.<br>
                            Si creas una nueva, tendr√° un <strong style="color:var(--red)">nuevo periodo de bloqueo de 6 meses</strong>.
                        </div>
                        <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;">
                            <button onclick="closeInvestModal(); window._currentDetailInv = { id: ${activeSDTC.id}, amount: ${activeSDTC.amount}, lockEndDate: '${activeSDTC.lockEndDate || activeSDTC.endDate}', type: '${activeSDTC.type}' }; openAddCapitalModal();" 
                                style="padding:10px 20px;background:var(--blue);border:none;color:white;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;">
                                ‚ûï Reinvertir en la Actual (mismo plazo)
                            </button>
                            <span style="font-size:11px;color:var(--text-muted);align-self:center;">o contin√∫a abajo para crear una nueva</span>
                        </div>
                    </div>`;
            }
        } else {
            const warningEl = document.getElementById('invest-active-warning');
            if (warningEl) warningEl.style.display = 'none';
        }

        document.getElementById('invest-available-display').textContent = formatCOP(balanceSummary.availableBalance);
        document.getElementById('invest-amount').value = '';
        document.getElementById('invest-preview').style.display = 'none';
        document.getElementById('btn-invest').disabled = true;
        document.getElementById('investModal').classList.add('open');
    }
    function closeInvestModal() { document.getElementById('investModal').classList.remove('open'); }

    function updateInvestPreview() {
        const amount = parseFloat(document.getElementById('invest-amount').value) || 0;
        const preview = document.getElementById('invest-preview');
        const btn = document.getElementById('btn-invest');

        if (amount >= 100000 && amount <= balanceSummary.availableBalance) {
            const unlockDate = new Date();
            unlockDate.setMonth(unlockDate.getMonth() + 6);
            const minGain = amount * 0.02 * 6;
            const maxGain = amount * 0.04 * 6;

            document.getElementById('preview-capital').textContent = formatCOP(amount);
            document.getElementById('preview-unlock').textContent = formatDate(unlockDate);
            document.getElementById('preview-min-gain').textContent = '+' + formatCOP(minGain);
            document.getElementById('preview-max-gain').textContent = '+' + formatCOP(maxGain);

            preview.style.display = 'block';
            btn.disabled = false;
        } else {
            preview.style.display = 'none';
            btn.disabled = true;
        }
    }

    async function executeInvestment() {
        const amount = parseFloat(document.getElementById('invest-amount').value);
        const btn = document.getElementById('btn-invest');
        btn.disabled = true;
        btn.textContent = 'Procesando...';

        try {
            const res = await apiFetch('/investments/create', {
                method: 'POST',
                body: JSON.stringify({ productId: 'sdtc_6m', amount })
            });
            const data = await res.json();
            if (!res.ok) { toast(data.error || 'Error al invertir', 'error'); return; }

            closeInvestModal();
            toast('‚úÖ Inversi√≥n SDTC creada exitosamente');
            await loadAllData();
            renderCurrentView();
        } catch (e) {
            toast('Error de conexi√≥n', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Confirmar Inversi√≥n ‚Üí';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD CAPITAL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function openAddCapitalModal() {
        const inv = window._currentDetailInv;
        if (!inv) return;

        document.getElementById('ac-inv-label').textContent = `${inv.type} #${inv.id}`;
        document.getElementById('ac-current').textContent = formatCOP(inv.amount);
        document.getElementById('ac-lock-date').textContent = formatDate(inv.lockEndDate);
        document.getElementById('ac-available-display').textContent = formatCOP(balanceSummary.availableBalance);
        document.getElementById('ac-amount').value = '';
        document.getElementById('ac-preview').style.display = 'none';
        document.getElementById('btn-add-capital-confirm').disabled = true;
        document.getElementById('addCapitalModal').classList.add('open');
    }

    function closeAddCapitalModal() {
        document.getElementById('addCapitalModal').classList.remove('open');
    }

    function updateAddCapitalPreview() {
        const inv = window._currentDetailInv;
        if (!inv) return;

        const amount = parseFloat(document.getElementById('ac-amount').value) || 0;
        const preview = document.getElementById('ac-preview');
        const btn = document.getElementById('btn-add-capital-confirm');

        if (amount >= 50000 && amount <= balanceSummary.availableBalance) {
            document.getElementById('acp-current').textContent = formatCOP(inv.amount);
            document.getElementById('acp-added').textContent = '+' + formatCOP(amount);
            document.getElementById('acp-new-total').textContent = formatCOP(inv.amount + amount);
            preview.style.display = 'block';
            btn.disabled = false;
        } else {
            preview.style.display = 'none';
            btn.disabled = true;
        }
    }

    async function executeAddCapital() {
        const inv = window._currentDetailInv;
        if (!inv) return;

        const amount = parseFloat(document.getElementById('ac-amount').value);
        const btn = document.getElementById('btn-add-capital-confirm');
        btn.disabled = true;
        btn.textContent = 'Procesando...';

        try {
            const res = await apiFetch(`/investments/${inv.id}/add-capital`, {
                method: 'POST',
                body: JSON.stringify({ amount })
            });
            const data = await res.json();
            if (!res.ok) { toast(data.error || 'Error al agregar capital', 'error'); return; }

            closeAddCapitalModal();
            toast(`‚úÖ ${formatCOP(amount)} agregado a tu inversi√≥n SDTC`);
            await loadAllData();
            showInvestmentDetail(inv.id);
        } catch (e) {
            toast('Error de conexi√≥n', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Confirmar Capital Adicional ‚Üí';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WITHDRAW INVESTMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function withdrawInvestment(invId) {
        if (!confirm('¬øEst√°s seguro de que deseas retirar esta inversi√≥n?\n\nEl capital ser√° devuelto a tu saldo disponible.')) return;

        try {
            const res = await apiFetch(`/investments/${invId}/withdraw`, { method: 'POST' });
            const data = await res.json();
            if (!res.ok) { toast(data.error || 'Error al retirar', 'error'); return; }

            toast(`‚úÖ Inversi√≥n retirada. ${formatCOP(data.investment.capitalReturned)} devuelto a tu saldo.`);
            await loadAllData();
            renderCurrentView();
        } catch (e) {
            toast('Error de conexi√≥n', 'error');
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CANCEL / CONFIRM PENDING INVESTMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function cancelPendingInvestment(invId) {
        if (!confirm('¬øCancelar esta inversi√≥n?\n\nEl capital volver√° inmediatamente a tu saldo disponible.')) return;

        try {
            const res = await apiFetch(`/investments/${invId}/cancel`, { method: 'POST' });
            const data = await res.json();
            if (!res.ok) { toast(data.error || 'Error al cancelar', 'error'); return; }

            toast(`‚úÖ Inversi√≥n cancelada. ${formatCOP(data.refundedAmount)} devuelto a tu saldo.`);
            await loadAllData();
            renderCurrentView();
        } catch (e) { toast('Error de conexi√≥n', 'error'); }
    }

    async function confirmPendingInvestment(invId) {
        if (!confirm('¬øConfirmar esta inversi√≥n?\n\nSe activar√° inmediatamente y el capital quedar√° bloqueado por 6 meses.')) return;

        try {
            const res = await apiFetch(`/investments/${invId}/confirm`, { method: 'POST' });
            const data = await res.json();
            if (!res.ok) { toast(data.error || 'Error al confirmar', 'error'); return; }

            toast('‚úÖ Inversi√≥n confirmada y activada.');
            await loadAllData();
            showInvestmentDetail(invId);
        } catch (e) { toast('Error de conexi√≥n', 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WITHDRAW VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let userPaymentMethods = [];
    let userWithdrawals = [];

    async function loadWithdrawData() {
        try {
            const [pmRes, wrRes] = await Promise.all([
                apiFetch('/withdrawals/payment-methods'),
                apiFetch('/withdrawals/my'),
            ]);
            if (pmRes && pmRes.ok) userPaymentMethods = await pmRes.json();
            if (wrRes && wrRes.ok) userWithdrawals = await wrRes.json();
        } catch(e) { console.error('Error loading withdraw data:', e); }
    }

    async function renderWithdrawView(container) {
        await loadWithdrawData();

        const pmTypeIcons = { nequi: 'üíú', bancolombia: 'üíõ', daviplata: 'üü¢', otro: 'üè¶' };
        const pmTypeNames = { nequi: 'Nequi', bancolombia: 'Bancolombia', daviplata: 'Daviplata', otro: 'Otro' };
        const statusLabels = { pending: '‚è≥ Pendiente', approved: '‚úÖ Aprobado', rejected: '‚ùå Rechazado', completed: 'üí∞ Completado' };
        const statusBadge = { pending: 'badge-profit', approved: 'badge-deposit', rejected: 'badge-withdraw', completed: 'badge-investment' };

        // Calcular limite mensual usado
        const now = new Date();
        const thisMonthWithdrawals = userWithdrawals.filter(w => {
            const d = new Date(w.created_at);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() && ['pending','approved','completed'].includes(w.status);
        });
        const monthlyUsed = thisMonthWithdrawals.reduce((s, w) => s + parseFloat(w.amount), 0);
        const monthlyRemaining = Math.max(0, 2000000 - monthlyUsed);

        container.innerHTML = `
        <!-- Info Cards -->
        <div class="stats-grid animate-in" style="grid-template-columns:repeat(3,1fr);">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" style="color:var(--green)">${formatCOP(balanceSummary.availableBalance)}</div>
                <div class="stat-label">Disponible para Retirar</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-value" style="color:var(--gold)">${formatCOP(monthlyRemaining)}</div>
                <div class="stat-label">L√≠mite Mensual Restante</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì§</div>
                <div class="stat-value">${userWithdrawals.filter(w => w.status === 'pending').length}</div>
                <div class="stat-label">Retiros Pendientes</div>
            </div>
        </div>

        <!-- Avisos -->
        <div style="background:var(--dark-2);border:1px solid var(--border);padding:16px 20px;margin-bottom:20px;" class="animate-in delay-1">
            <div style="font-size:12px;color:var(--text-muted);line-height:1.8;">
                ‚è±Ô∏è <strong style="color:var(--text)">Retiros hasta $2.000.000/mes</strong> se procesan en <strong style="color:var(--gold)">48 horas</strong><br>
                üìÖ <strong style="color:var(--text)">Retiros mayores</strong> requieren aprobaci√≥n especial y pueden tomar <strong style="color:var(--red)">hasta 30 d√≠as</strong><br>
                üí∞ <strong style="color:var(--text)">L√≠mite mensual:</strong> $2.000.000 COP
            </div>
        </div>

        <!-- M√©todos de Pago -->
        <div style="background:var(--dark-2);border:1px solid var(--border);padding:24px;margin-bottom:20px;" class="animate-in delay-1">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;">üí≥ M√©todos de Pago</div>
                <button onclick="showAddPaymentMethodForm()" style="padding:8px 16px;background:var(--gold-dim);color:var(--gold);border:1px solid var(--border);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='var(--gold)';this.style.color='var(--dark)'" onmouseout="this.style.background='var(--gold-dim)';this.style.color='var(--gold)'">+ Agregar M√©todo</button>
            </div>
            
            <div id="payment-methods-list">
                ${userPaymentMethods.length > 0 ? userPaymentMethods.map(pm => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--dark-3);border:1px solid var(--border);margin-bottom:8px;${pm.is_default ? 'border-color:var(--gold);' : ''}">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span style="font-size:20px;">${pmTypeIcons[pm.type] || 'üè¶'}</span>
                            <div>
                                <div style="font-weight:600;font-size:14px;">${pm.label} ${pm.is_default ? '<span style="font-size:10px;color:var(--gold);background:var(--gold-dim);padding:2px 8px;">DEFAULT</span>' : ''}</div>
                                <div style="font-size:12px;color:var(--text-muted);">${pmTypeNames[pm.type]} ¬∑ ${pm.phone || pm.account_number || ''} ${pm.account_type ? '(' + pm.account_type + ')' : ''}</div>
                            </div>
                        </div>
                        <button onclick="deletePaymentMethod(${pm.id})" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:6px 12px;font-size:11px;cursor:pointer;" onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)'">Eliminar</button>
                    </div>
                `).join('') : '<div style="text-align:center;padding:30px;color:var(--text-muted);font-size:13px;">No tienes m√©todos de pago registrados. Agrega uno para poder retirar.</div>'}
            </div>

            <!-- Add payment method form (hidden) -->
            <div id="add-pm-form" style="display:none;margin-top:16px;padding:20px;background:var(--dark-3);border:1px solid var(--border);">
                <div style="font-weight:700;font-size:14px;margin-bottom:16px;">Nuevo M√©todo de Pago</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Tipo *</label>
                        <select id="pm-type" style="padding:10px;background:var(--input);border:1px solid var(--border);color:var(--text);font-family:'DM Sans',sans-serif;outline:none;" onchange="togglePMFields()">
                            <option value="nequi">üíú Nequi</option>
                            <option value="bancolombia">üíõ Bancolombia</option>
                            <option value="daviplata">üü¢ Daviplata</option>
                        </select>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Nombre / Alias *</label>
                        <input id="pm-label" placeholder="Ej: Mi Nequi" style="padding:10px;background:var(--input);border:1px solid var(--border);color:var(--text);font-family:'DM Sans',sans-serif;outline:none;">
                    </div>
                </div>
                <div id="pm-phone-fields" style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:12px;">
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Tel√©fono (10 d√≠gitos) *</label>
                        <input id="pm-phone" placeholder="3101234567" maxlength="10" style="padding:10px;background:var(--input);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;outline:none;">
                    </div>
                </div>
                <div id="pm-bank-fields" style="display:none;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">N√∫mero de Cuenta *</label>
                        <input id="pm-account" placeholder="000012345678" style="padding:10px;background:var(--input);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;outline:none;">
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Tipo de Cuenta *</label>
                        <select id="pm-account-type" style="padding:10px;background:var(--input);border:1px solid var(--border);color:var(--text);font-family:'DM Sans',sans-serif;outline:none;">
                            <option value="ahorros">Ahorros</option>
                            <option value="corriente">Corriente</option>
                        </select>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Titular *</label>
                        <input id="pm-holder" placeholder="Nombre completo" style="padding:10px;background:var(--input);border:1px solid var(--border);color:var(--text);font-family:'DM Sans',sans-serif;outline:none;">
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">C√©dula Titular</label>
                        <input id="pm-holder-doc" placeholder="1234567890" style="padding:10px;background:var(--input);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;outline:none;">
                    </div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="savePaymentMethod()" style="padding:10px 24px;background:var(--gold);border:none;color:var(--dark);font-family:'Syne',sans-serif;font-size:12px;font-weight:700;cursor:pointer;">Guardar</button>
                    <button onclick="document.getElementById('add-pm-form').style.display='none'" style="padding:10px 24px;background:transparent;border:1px solid var(--border);color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Formulario de Retiro -->
        <div style="background:var(--dark-2);border:1px solid var(--border);padding:24px;margin-bottom:20px;" class="animate-in delay-2">
            <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:16px;">üì§ Solicitar Retiro</div>
            
            ${userPaymentMethods.length === 0 ? `
                <div style="text-align:center;padding:30px;color:var(--text-muted);">
                    ‚ö†Ô∏è Primero debes registrar un m√©todo de pago arriba para poder solicitar un retiro.
                </div>
            ` : `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">M√©todo de Pago *</label>
                        <select id="wr-pm" style="padding:12px;background:var(--dark-3);border:1px solid var(--border);color:var(--text);font-family:'DM Sans',sans-serif;outline:none;">
                            ${userPaymentMethods.map(pm => `<option value="${pm.id}">${pmTypeIcons[pm.type]} ${pm.label} ‚Äî ${pm.phone || pm.account_number || ''}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">Monto a Retirar (COP) *</label>
                        <input id="wr-amount" type="number" placeholder="500000" min="10000" max="${Math.min(monthlyRemaining, balanceSummary.availableBalance)}" oninput="updateWithdrawPreview()" style="padding:12px;background:var(--dark-3);border:1px solid var(--border);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:16px;outline:none;">
                    </div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:16px;">
                    Disponible: <strong style="color:var(--green)">${formatCOP(balanceSummary.availableBalance)}</strong> ¬∑ 
                    L√≠mite restante este mes: <strong style="color:var(--gold)">${formatCOP(monthlyRemaining)}</strong>
                </div>

                <div id="wr-preview" style="display:none;background:var(--dark-3);border:1px solid var(--border);padding:16px;margin-bottom:16px;">
                    <div id="wr-preview-content"></div>
                </div>

                <button id="btn-withdraw-request" onclick="submitWithdrawalRequest()" disabled style="padding:14px 28px;background:var(--gold);border:none;color:var(--dark);font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;opacity:0.5;">
                    Solicitar Retiro ‚Üí
                </button>
            `}
        </div>

        <!-- Historial de Retiros -->
        ${userWithdrawals.length > 0 ? `
        <div class="table-card animate-in delay-3">
            <div class="table-header"><span class="table-title">üìã Historial de Retiros</span></div>
            <table class="data-table">
                <thead><tr><th>Ref</th><th>Monto</th><th>M√©todo</th><th>Estado</th><th>Tiempo Est.</th><th>Fecha</th></tr></thead>
                <tbody>${userWithdrawals.map(w => `
                    <tr>
                        <td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${w.ref_id || '-'}</td>
                        <td style="font-family:'JetBrains Mono',monospace;color:var(--red);">-${formatCOP(w.amount)}</td>
                        <td>${pmTypeIcons[w.pm_type] || 'üè¶'} ${w.pm_label || '-'}</td>
                        <td><span class="badge ${statusBadge[w.status] || 'badge-profit'}">${statusLabels[w.status] || w.status}</span></td>
                        <td style="font-size:12px;color:var(--text-muted);">${w.estimated_completion || '-'}</td>
                        <td style="color:var(--text-muted)">${formatDate(w.created_at)}</td>
                    </tr>
                `).join('')}</tbody>
            </table>
        </div>` : ''}`;
    }

    function showAddPaymentMethodForm() {
        document.getElementById('add-pm-form').style.display = 'block';
        togglePMFields();
    }

    function togglePMFields() {
        const type = document.getElementById('pm-type').value;
        const phoneFields = document.getElementById('pm-phone-fields');
        const bankFields = document.getElementById('pm-bank-fields');
        if (type === 'bancolombia') {
            phoneFields.style.display = 'none';
            bankFields.style.display = 'grid';
        } else {
            phoneFields.style.display = 'grid';
            bankFields.style.display = 'none';
        }
    }

    async function savePaymentMethod() {
        const type = document.getElementById('pm-type').value;
        const label = document.getElementById('pm-label').value.trim();
        if (!label) return toast('Ingresa un nombre para el m√©todo', 'error');

        const body = { type, label };
        if (type === 'nequi' || type === 'daviplata') {
            body.phone = document.getElementById('pm-phone').value.trim();
            if (!body.phone || body.phone.length !== 10) return toast('Tel√©fono debe tener 10 d√≠gitos', 'error');
        } else if (type === 'bancolombia') {
            body.accountNumber = document.getElementById('pm-account').value.trim();
            body.accountType = document.getElementById('pm-account-type').value;
            body.holderName = document.getElementById('pm-holder').value.trim();
            body.holderDocument = document.getElementById('pm-holder-doc').value.trim();
            if (!body.accountNumber || !body.holderName) return toast('Completa los datos de la cuenta', 'error');
        }

        try {
            const res = await apiFetch('/withdrawals/payment-methods', { method: 'POST', body: JSON.stringify(body) });
            const data = await res.json();
            if (!res.ok) return toast(data.error, 'error');
            toast('‚úÖ M√©todo de pago registrado');
            renderWithdrawView(document.getElementById('dashboard-content'));
        } catch(e) { toast('Error de conexi√≥n', 'error'); }
    }

    async function deletePaymentMethod(id) {
        if (!confirm('¬øEliminar este m√©todo de pago?')) return;
        try {
            const res = await apiFetch(`/withdrawals/payment-methods/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (!res.ok) return toast(data.error, 'error');
            toast('M√©todo eliminado');
            renderWithdrawView(document.getElementById('dashboard-content'));
        } catch(e) { toast('Error', 'error'); }
    }

    function updateWithdrawPreview() {
        const amount = parseFloat(document.getElementById('wr-amount').value) || 0;
        const preview = document.getElementById('wr-preview');
        const btn = document.getElementById('btn-withdraw-request');
        const maxAllowed = Math.min(2000000, balanceSummary.availableBalance);

        if (amount >= 10000 && amount <= maxAllowed) {
            const est = amount <= 2000000 ? '48 horas' : '30 d√≠as';
            const estColor = amount <= 2000000 ? 'var(--gold)' : 'var(--red)';
            document.getElementById('wr-preview-content').innerHTML = `
                <div style="display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid var(--border);">
                    <span style="color:var(--text-muted);">Monto a retirar</span>
                    <span style="font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--red);">-${formatCOP(amount)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:13px;padding:6px 0;border-bottom:1px solid var(--border);">
                    <span style="color:var(--text-muted);">Tiempo estimado</span>
                    <span style="font-weight:600;color:${estColor};">${est}</span>
                </div>
                ${amount > 2000000 ? `<div style="margin-top:10px;font-size:11px;color:var(--red);line-height:1.6;">‚ö†Ô∏è Retiros mayores a $2.000.000 requieren aprobaci√≥n especial y pueden demorar hasta 30 d√≠as h√°biles.</div>` : ''}
                <div style="margin-top:10px;font-size:11px;color:var(--text-muted);">El retiro ser√° enviado al m√©todo de pago seleccionado una vez aprobado por el equipo.</div>
            `;
            preview.style.display = 'block';
            btn.disabled = false;
            btn.style.opacity = '1';
        } else {
            preview.style.display = 'none';
            btn.disabled = true;
            btn.style.opacity = '0.5';
        }
    }

    async function submitWithdrawalRequest() {
        const amount = parseFloat(document.getElementById('wr-amount').value);
        const paymentMethodId = parseInt(document.getElementById('wr-pm').value);
        const btn = document.getElementById('btn-withdraw-request');

        btn.disabled = true;
        btn.textContent = 'Procesando...';

        try {
            const res = await apiFetch('/withdrawals/request', {
                method: 'POST',
                body: JSON.stringify({ amount, paymentMethodId })
            });
            const data = await res.json();
            if (!res.ok) return toast(data.error, 'error');

            toast(`‚úÖ Solicitud de retiro por ${formatCOP(amount)} creada. ${data.withdrawal.estimatedCompletion}`);
            await loadAllData();
            renderWithdrawView(document.getElementById('dashboard-content'));
        } catch(e) {
            toast('Error de conexi√≥n', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Solicitar Retiro ‚Üí';
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHART ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function drawChart(history) {
        if (!history || !history.length) return;
        const svg = document.getElementById('chart-svg');
        if (!svg) return;
        const w = 500, h = 200, pad = 30;
        const vals = history.map(h => h.amount);
        const min = Math.min(...vals) * 0.9;
        const max = Math.max(...vals) * 1.05;
        const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        const points = history.map((item, i) => {
            const x = pad + (i / Math.max(history.length - 1, 1)) * (w - pad * 2);
            const y = h - pad - ((item.amount - min) / (max - min || 1)) * (h - pad * 2);
            return { x, y, label: months[new Date(item.date).getMonth()], ...item };
        });
        const pathD = points.map((p, i) => {
            if (i === 0) return `M ${p.x} ${p.y}`;
            const prev = points[i-1]; const cpx1 = prev.x + (p.x - prev.x)/3; const cpx2 = prev.x + (p.x - prev.x)*2/3;
            return `C ${cpx1} ${prev.y}, ${cpx2} ${p.y}, ${p.x} ${p.y}`;
        }).join(' ');
        const areaD = pathD + ` L ${points[points.length-1].x} ${h-pad} L ${points[0].x} ${h-pad} Z`;
        let svgContent = `<defs><linearGradient id="lineGrad" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#C9A84C"/><stop offset="100%" stop-color="#E8C96A"/></linearGradient><linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="rgba(201,168,76,0.2)"/><stop offset="100%" stop-color="rgba(201,168,76,0)"/></linearGradient></defs>`;
        for (let i = 0; i < 4; i++) { const y = pad + (i/3)*(h-pad*2); svgContent += `<line x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}" stroke="rgba(201,168,76,0.1)" stroke-width="1"/>`; }
        svgContent += `<path d="${areaD}" fill="url(#areaGrad)"/><path d="${pathD}" fill="none" stroke="url(#lineGrad)" stroke-width="2.5" stroke-linecap="round"/>`;
        points.forEach(p => { svgContent += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="var(--dark)" stroke="#C9A84C" stroke-width="2"/><text x="${p.x}" y="${h-8}" text-anchor="middle" fill="#7A7670" font-size="10" font-family="DM Sans">${p.label}</text>`; });
        svg.innerHTML = svgContent;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOAD DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadAllData() {
        try {
            const [dashRes, balRes, invRes] = await Promise.all([
                apiFetch('/dashboard/summary'),
                apiFetch('/investments/balance-summary'),
                apiFetch('/investments/my'),
            ]);

            if (dashRes && dashRes.ok) dashboardData = await dashRes.json();
            if (balRes && balRes.ok) balanceSummary = await balRes.json();
            if (invRes && invRes.ok) myInvestments = await invRes.json();

            // Fallback: si balance-summary no funciona todav√≠a, calcular del dashboard
            if (!balRes || !balRes.ok) {
                if (dashboardData) {
                    const totalInv = dashboardData.investments.filter(i => i.status === 'active').reduce((s, i) => s + i.amount, 0);
                    balanceSummary = {
                        totalBalance: dashboardData.balance,
                        totalInvested: totalInv,
                        availableBalance: Math.max(0, dashboardData.balance - totalInv),
                        totalEarnings: dashboardData.totalProfit,
                    };
                }
            }

            // Fallback: si investments/my no funciona, usar del dashboard
            if (!invRes || !invRes.ok) {
                if (dashboardData) {
                    myInvestments = dashboardData.investments.map(inv => ({
                        ...inv,
                        durationMonths: 6,
                        minMonthlyRate: 2,
                        maxMonthlyRate: 4,
                        lockEndDate: inv.endDate || null,
                        progressPct: 0,
                        daysRemaining: 0,
                        totalEarned: 0,
                        returns: [],
                    }));
                }
            }
        } catch (e) {
            console.error('Error loading data:', e);
        }
    }

    async function init() {
        const user = getUserData();
        if (user) {
            setGreeting(user.fullName || user.email);
            const initials = (user.fullName || user.email).split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            document.getElementById('user-name').textContent = user.fullName || user.email;
            document.getElementById('user-email').textContent = user.email;
        }

        document.getElementById('date-display').textContent = new Date().toLocaleDateString('es-CO', { weekday:'long', day:'numeric', month:'short' });

        await loadAllData();

        if (dashboardData) {
            renderCurrentView();
        } else {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="error-state">
                    <p>‚ö†Ô∏è No se pudo cargar la informaci√≥n</p>
                    <button onclick="init()">Reintentar</button>
                    <button onclick="logout()" style="background:transparent;border:1px solid var(--red);color:var(--red);margin-left:8px;">Cerrar sesi√≥n</button>
                </div>`;
        }
    }

    init();
</script>
</body>
</html>