<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanse Capital ‚Äî Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f; --bg2: #111118; --card: #14141d; --input: #1c1c28;
            --gold: #d4a843; --gold-light: #e8c56d; --gold-dark: #b8922e;
            --text: #f0ede6; --text2: #8a8a9a; --muted: #55556a; --border: #222233;
            --green: #4ecb8d; --red: #e74c5e; --blue: #5b8def; --purple: #a78bfa;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* Topbar */
        .topbar {
            background:var(--bg2); border-bottom:1px solid var(--border); padding:16px 32px;
            display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:50;
        }
        .topbar h1 {
            font-family:'Playfair Display',serif; font-size:20px;
            background:linear-gradient(135deg,var(--gold-light),var(--gold));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        }
        .topbar-sub { font-size:11px; color:var(--muted); letter-spacing:2px; text-transform:uppercase; }
        .topbar-right { display:flex; gap:12px; align-items:center; }
        .topbar-right a { color:var(--text2); text-decoration:none; font-size:13px; padding:8px 16px; border:1px solid var(--border); border-radius:8px; transition:all 0.2s; }
        .topbar-right a:hover { border-color:var(--gold); color:var(--gold); }

        .container { max-width:1100px; margin:0 auto; padding:32px 24px; }

        /* Stats */
        .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:32px; }
        .stat-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:22px; text-align:center; }
        .stat-card .val { font-size:22px; font-weight:700; font-family:'JetBrains Mono',monospace; }
        .stat-card .val.green { color:var(--green); }
        .stat-card .val.red { color:var(--red); }
        .stat-card .val.blue { color:var(--blue); }
        .stat-card .val.gold { color:var(--gold); }
        .stat-card .lbl { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-top:6px; }

        /* Tabs */
        .tabs { display:flex; gap:4px; margin-bottom:28px; background:var(--bg2); border-radius:12px; padding:4px; border:1px solid var(--border); }
        .tab { flex:1; padding:12px; text-align:center; border-radius:10px; cursor:pointer; font-size:14px; font-weight:600; color:var(--text2); transition:all 0.2s; }
        .tab:hover { color:var(--text); }
        .tab.active { background:var(--gold); color:#0a0a0f; }

        /* Sections */
        .section { display:none; }
        .section.active { display:block; }

        /* Cards */
        .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:28px; margin-bottom:24px; }
        .card-title { font-size:18px; font-weight:700; margin-bottom:20px; display:flex; align-items:center; gap:10px; }
        .card-desc { color:var(--text2); font-size:13px; margin-bottom:20px; line-height:1.5; }

        /* Forms */
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
        .form-row.cols-3 { grid-template-columns:1fr 1fr 1fr; }
        .form-group { display:flex; flex-direction:column; gap:6px; }
        .form-group.full { grid-column:1/-1; }
        label { font-size:11px; font-weight:600; color:var(--text2); text-transform:uppercase; letter-spacing:0.5px; }
        input, select, textarea {
            padding:12px 14px; background:var(--input); border:1px solid var(--border); border-radius:10px;
            color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; outline:none; transition:border 0.2s;
        }
        input:focus, select:focus { border-color:var(--gold); }
        select { cursor:pointer; }
        input::placeholder { color:var(--muted); }

        /* Buttons */
        .btn {
            padding:12px 28px; border:none; border-radius:10px; font-family:'DM Sans',sans-serif;
            font-size:14px; font-weight:600; cursor:pointer; transition:all 0.2s; display:inline-flex; align-items:center; gap:8px;
        }
        .btn-gold { background:linear-gradient(135deg,var(--gold),var(--gold-dark)); color:#0a0a0f; }
        .btn-gold:hover { box-shadow:0 4px 20px rgba(212,168,67,0.3); transform:translateY(-1px); }
        .btn-gold:disabled { opacity:0.5; cursor:not-allowed; transform:none; box-shadow:none; }
        .btn-outline { background:transparent; color:var(--text2); border:1px solid var(--border); }
        .btn-outline:hover { border-color:var(--gold); color:var(--gold); }
        .btn-sm { padding:6px 14px; font-size:12px; border-radius:8px; }
        .btn-red { background:rgba(231,76,94,0.12); color:var(--red); border:1px solid rgba(231,76,94,0.25); }

        /* Table */
        .table-wrap { overflow-x:auto; margin-top:16px; }
        table { width:100%; border-collapse:collapse; }
        th { text-align:left; padding:10px 14px; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border); }
        td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(34,34,51,0.5); }
        tr:hover td { background:rgba(212,168,67,0.02); }
        .mono { font-family:'JetBrains Mono',monospace; font-weight:500; }
        .badge { display:inline-block; padding:3px 10px; border-radius:100px; font-size:11px; font-weight:600; }
        .badge-green { color:var(--green); background:rgba(78,203,141,0.1); }
        .badge-gold { color:var(--gold); background:rgba(212,168,67,0.1); }
        .badge-red { color:var(--red); background:rgba(231,76,94,0.1); }
        .badge-blue { color:var(--blue); background:rgba(91,141,239,0.1); }
        .badge-purple { color:var(--purple); background:rgba(167,139,250,0.1); }

        /* Toast */
        .toast { position:fixed; bottom:24px; right:24px; padding:14px 24px; border-radius:12px; font-size:13px; font-weight:600; z-index:999; transform:translateY(100px); opacity:0; transition:all 0.3s; }
        .toast.show { transform:translateY(0); opacity:1; }
        .toast-success { background:var(--green); color:#0a0a0f; }
        .toast-error { background:var(--red); color:white; }

        /* Users list */
        .user-list { display:grid; gap:8px; margin-top:16px; }
        .user-row {
            display:flex; align-items:center; justify-content:space-between; padding:14px 18px;
            background:var(--input); border-radius:12px; border:1px solid transparent; transition:all 0.2s;
        }
        .user-row:hover { border-color:var(--border); }
        .user-row-left { display:flex; align-items:center; gap:14px; }
        .user-avatar-sm {
            width:36px; height:36px; border-radius:8px; background:linear-gradient(135deg,var(--gold),var(--gold-dark));
            display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; color:#0a0a0f;
        }
        .user-row-name { font-size:14px; font-weight:600; }
        .user-row-email { font-size:12px; color:var(--text2); }
        .user-row-right { display:flex; align-items:center; gap:12px; }

        /* Investment cards for returns section */
        .inv-card {
            background:var(--input); border:1px solid var(--border); border-radius:14px; padding:20px;
            margin-bottom:12px; cursor:pointer; transition:all 0.2s;
        }
        .inv-card:hover { border-color:var(--gold); }
        .inv-card.selected { border-color:var(--gold); background:rgba(212,168,67,0.05); box-shadow:0 0 0 1px var(--gold); }
        .inv-card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .inv-card-user { font-weight:600; font-size:15px; }
        .inv-card-type { font-size:12px; color:var(--gold); font-weight:600; }
        .inv-card-details { display:flex; gap:24px; flex-wrap:wrap; }
        .inv-card-detail { display:flex; flex-direction:column; gap:2px; }
        .inv-card-detail .label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
        .inv-card-detail .value { font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:500; }
        .inv-card-returns { margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
        .inv-card-returns-title { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
        .return-tag { display:inline-block; padding:3px 10px; border-radius:8px; font-size:11px; margin:2px 4px 2px 0; background:rgba(78,203,141,0.1); color:var(--green); font-family:'JetBrains Mono',monospace; }

        /* Preview box */
        .preview-box {
            background:rgba(212,168,67,0.06); border:1px solid rgba(212,168,67,0.2); border-radius:12px;
            padding:20px; margin:16px 0;
        }
        .preview-box h4 { font-size:13px; color:var(--gold); margin-bottom:12px; text-transform:uppercase; letter-spacing:1px; }
        .preview-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
        .preview-item .label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
        .preview-item .value { font-family:'JetBrains Mono',monospace; font-size:18px; font-weight:600; color:var(--text); margin-top:4px; }
        .preview-item .value.green { color:var(--green); }

        @media(max-width:768px) {
            .form-row, .form-row.cols-3 { grid-template-columns:1fr; }
            .stats-row { grid-template-columns:1fr 1fr; }
            .tabs { flex-wrap:wrap; }
            .container { padding:16px; }
            .topbar { padding:12px 16px; }
            .preview-grid { grid-template-columns:1fr; }
            .inv-card-details { gap:12px; }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div>
            <h1>SANSE CAPITAL</h1>
            <div class="topbar-sub">Panel de Administraci√≥n</div>
        </div>
        <div class="topbar-right">
            <a href="dashboard.html">‚Üê Dashboard</a>
            <a href="#" onclick="logout()">Cerrar Sesi√≥n</a>
        </div>
    </div>

    <div class="container">
        <!-- STATS -->
        <div class="stats-row">
            <div class="stat-card"><div class="val gold" id="st-users">0</div><div class="lbl">Total Usuarios</div></div>
            <div class="stat-card"><div class="val green" id="st-balance">$0</div><div class="lbl">Balance en Ahorro</div></div>
            <div class="stat-card"><div class="val blue" id="st-loans">$0</div><div class="lbl">Pr√©stamos Total</div></div>
            <div class="stat-card"><div class="val red" id="st-withdrawals">$0</div><div class="lbl">Retiros Total</div></div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('register',this)">üë§ Registrar</div>
            <div class="tab" onclick="switchTab('transactions',this)">üí∏ Transacci√≥n</div>
            <div class="tab" onclick="switchTab('returns',this)">üìà Rendimientos</div>
            <div class="tab" onclick="switchTab('users',this)">üìã Usuarios</div>
        </div>

        <!-- ====== REGISTRAR USUARIO ====== -->
        <div class="section active" id="sec-register">
            <div class="card">
                <div class="card-title">üë§ Nuevo Usuario</div>
                <div class="card-desc">Registra un nuevo cliente, administrador o instituci√≥n en la plataforma.</div>

                <div class="form-row">
                    <div class="form-group"><label>Nombre Completo *</label><input id="u-name" placeholder="Santiago Rubiano"></div>
                    <div class="form-group"><label>Correo Electr√≥nico *</label><input id="u-email" type="email" placeholder="santiago@email.com"></div>
                </div>
                <div class="form-row cols-3">
                    <div class="form-group"><label>C√©dula (CC)</label><input id="u-cc" placeholder="1234567890"></div>
                    <div class="form-group"><label>Tel√©fono</label><input id="u-phone" placeholder="3194101127"></div>
                    <div class="form-group"><label>Rol *</label>
                        <select id="u-role">
                            <option value="client">Cliente</option>
                            <option value="admin">Administrador</option>
                            <option value="institution">Instituci√≥n</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Contrase√±a *</label><input id="u-pass" type="password" placeholder="M√≠n 8 chars, 1 may√∫scula, 1 n√∫mero"></div>
                    <div class="form-group"><label>Balance Inicial (COP)</label><input id="u-balance" type="number" placeholder="0" value="0"></div>
                </div>
                <button class="btn btn-gold" onclick="createUser()" id="btn-create-user">üë§ Crear Usuario</button>
            </div>
        </div>

        <!-- ====== REGISTRAR TRANSACCI√ìN ====== -->
        <div class="section" id="sec-transactions">
            <div class="card">
                <div class="card-title">üí∏ Nueva Transacci√≥n</div>
                <div class="card-desc">Registra dep√≥sitos, retiros, intereses, ganancias, abonos o pr√©stamos para un usuario.</div>

                <div class="form-row">
                    <div class="form-group"><label>Usuario *</label><select id="t-user"><option value="">Seleccionar usuario...</option></select></div>
                    <div class="form-group"><label>Tipo de Transacci√≥n *</label>
                        <select id="t-type">
                            <option value="deposit">üí∞ Dep√≥sito</option>
                            <option value="withdraw">üì§ Retiro</option>
                            <option value="payment">üí≥ Abono</option>
                            <option value="interest">üìà Intereses</option>
                            <option value="profit">üèÜ Ganancias</option>
                            <option value="loan">üè¶ Pr√©stamo</option>
                        </select>
                    </div>
                </div>
                <div class="form-row cols-3">
                    <div class="form-group"><label>Monto (COP) *</label><input id="t-amount" type="number" placeholder="2000000"></div>
                    <div class="form-group"><label>Fecha</label><input id="t-date" type="date"></div>
                    <div class="form-group"><label>ID Transacci√≥n</label><input id="t-ref" placeholder="Auto" disabled style="opacity:0.5"></div>
                </div>
                <div class="form-row">
                    <div class="form-group full"><label>Descripci√≥n (opcional)</label><input id="t-desc" placeholder="Ej: Aporte mensual enero 2026"></div>
                </div>
                <button class="btn btn-gold" onclick="createTransaction()" id="btn-create-tx">üí∏ Registrar Transacci√≥n</button>
            </div>

            <!-- √öltimas transacciones -->
            <div class="card">
                <div class="card-title">üìã √öltimas Transacciones</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>ID</th><th>Usuario</th><th>Tipo</th><th>Monto</th><th>Descripci√≥n</th><th>Fecha</th></tr></thead>
                        <tbody id="tx-table"><tr><td colspan="6" style="color:var(--muted);text-align:center">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ====== RENDIMIENTOS SDTC ====== -->
        <div class="section" id="sec-returns">
            <div class="card">
                <div class="card-title">üìà Registrar Rendimiento SDTC</div>
                <div class="card-desc">
                    Selecciona una inversi√≥n activa y registra el rendimiento mensual. 
                    Se calcular√° autom√°ticamente la ganancia y se reflejar√° en el dashboard del usuario.
                </div>

                <!-- Lista de inversiones activas -->
                <div id="active-investments-list" style="margin-bottom:20px;">
                    <div style="color:var(--muted);text-align:center;padding:40px 0;">Cargando inversiones activas...</div>
                </div>

                <!-- Formulario de rendimiento (oculto hasta seleccionar inversi√≥n) -->
                <div id="return-form" style="display:none;">
                    <div style="height:1px;background:var(--border);margin:20px 0;"></div>
                    
                    <div class="card-title" style="font-size:15px;">üí∞ Nuevo Rendimiento para: <span id="rf-inv-label" style="color:var(--gold);"></span></div>

                    <div class="form-row cols-3">
                        <div class="form-group">
                            <label>Tasa Mensual (%) *</label>
                            <input id="rf-rate" type="number" step="0.01" min="0" max="100" placeholder="3.5" oninput="updateReturnPreview()">
                        </div>
                        <div class="form-group">
                            <label>Mes del Rendimiento *</label>
                            <input id="rf-month" type="month" oninput="updateReturnPreview()">
                        </div>
                        <div class="form-group">
                            <label>Notas (opcional)</label>
                            <input id="rf-notes" placeholder="Ej: Rendimiento marzo 2026">
                        </div>
                    </div>

                    <!-- Preview de la ganancia -->
                    <div class="preview-box" id="return-preview" style="display:none;">
                        <h4>üìä Vista Previa del Rendimiento</h4>
                        <div class="preview-grid">
                            <div class="preview-item">
                                <div class="label">Capital Invertido</div>
                                <div class="value" id="rp-capital">$0</div>
                            </div>
                            <div class="preview-item">
                                <div class="label">Tasa Aplicada</div>
                                <div class="value" id="rp-rate">0%</div>
                            </div>
                            <div class="preview-item">
                                <div class="label">Ganancia Generada</div>
                                <div class="value green" id="rp-earned">$0</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-gold" onclick="registerReturn()" id="btn-register-return" disabled>üìà Registrar Rendimiento</button>
                </div>
            </div>

            <!-- Historial de rendimientos registrados -->
            <div class="card">
                <div class="card-title">üìã √öltimos Rendimientos Registrados</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>Inversi√≥n</th><th>Usuario</th><th>Mes</th><th>Tasa</th><th>Ganancia</th><th>Capital</th></tr></thead>
                        <tbody id="returns-table"><tr><td colspan="6" style="color:var(--muted);text-align:center">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ====== VER USUARIOS ====== -->
        <div class="section" id="sec-users">
            <div class="card">
                <div class="card-title">üìã Usuarios Registrados</div>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>ID</th><th>Nombre</th><th>Email</th><th>CC</th><th>Rol</th><th>Creado</th></tr></thead>
                        <tbody id="users-table"><tr><td colspan="6" style="color:var(--muted);text-align:center">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const API_URL = 'https://sanse-backend-production.up.railway.app/api';

        // ====== AUTH ======
        function getToken() { return localStorage.getItem('sanse_access_token') || sessionStorage.getItem('sanse_access_token'); }
        function getStorage() { return localStorage.getItem('sanse_access_token') ? localStorage : sessionStorage; }
        function getUserData() { const d = localStorage.getItem('sanse_user') || sessionStorage.getItem('sanse_user'); return d ? JSON.parse(d) : null; }

        if (!getToken()) window.location.href = 'login.html';
        const userData = getUserData();
        if (userData && userData.role !== 'admin') { alert('Acceso denegado. Solo administradores.'); window.location.href = 'dashboard.html'; }

        function logout() {
            ['sanse_access_token','sanse_refresh_token','sanse_user'].forEach(k => { localStorage.removeItem(k); sessionStorage.removeItem(k); });
            window.location.href = 'login.html';
        }

        async function apiFetch(endpoint, options = {}) {
            const token = getToken();
            const config = { ...options, headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}`, ...options.headers } };
            let res = await fetch(`${API_URL}${endpoint}`, config);
            if (res.status === 401) {
                const ok = await refreshTokenFn();
                if (ok) { config.headers['Authorization'] = `Bearer ${getToken()}`; res = await fetch(`${API_URL}${endpoint}`, config); }
                else { logout(); return null; }
            }
            return res;
        }

        async function refreshTokenFn() {
            try {
                const rt = localStorage.getItem('sanse_refresh_token') || sessionStorage.getItem('sanse_refresh_token');
                if (!rt) return false;
                const res = await fetch(`${API_URL}/auth/refresh`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({refreshToken:rt}) });
                if (!res.ok) return false;
                const data = await res.json();
                const s = getStorage();
                s.setItem('sanse_access_token', data.accessToken);
                s.setItem('sanse_refresh_token', data.refreshToken);
                return true;
            } catch { return false; }
        }

        // ====== TOAST ======
        function toast(msg, type='success') {
            const el = document.getElementById('toast');
            el.textContent = msg; el.className = `toast toast-${type} show`;
            setTimeout(() => el.classList.remove('show'), 3500);
        }

        // ====== TABS ======
        function switchTab(tab, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(`sec-${tab}`).classList.add('active');
            // Cargar inversiones activas al entrar a la pesta√±a de rendimientos
            if (tab === 'returns') loadActiveInvestments();
        }

        // ====== FORMAT ======
        function formatCOP(n) { return '$' + Math.round(Number(n)).toLocaleString('es-CO'); }
        function formatDate(d) { return new Date(d).toLocaleDateString('es-CO', {day:'numeric',month:'short',year:'numeric'}); }

        // ====== DATA ======
        let allUsers = [];
        let activeInvestments = [];
        let selectedInvestment = null;

        async function loadData() {
            await loadUsers();
            await loadStats();
            loadRecentTransactions();
        }

        async function loadUsers() {
            try {
                const res = await apiFetch('/auth/users');
                if (!res || !res.ok) { console.error('Error loading users'); return; }
                const data = await res.json();
                allUsers = data.users || [];

                const tbody = document.getElementById('users-table');
                if (!allUsers.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="color:var(--muted);text-align:center">No hay usuarios</td></tr>';
                } else {
                    tbody.innerHTML = allUsers.map(u => `
                        <tr>
                            <td class="mono">${u.id}</td>
                            <td style="font-weight:600">${u.full_name}</td>
                            <td style="color:var(--text2)">${u.email}</td>
                            <td class="mono">${u.document_number || '‚Äî'}</td>
                            <td><span class="badge ${u.role==='admin'?'badge-gold':u.role==='institution'?'badge-purple':'badge-blue'}">${u.role}</span></td>
                            <td style="color:var(--muted)">${formatDate(u.created_at)}</td>
                        </tr>
                    `).join('');
                }

                const sel = document.getElementById('t-user');
                sel.innerHTML = '<option value="">Seleccionar usuario...</option>' +
                    allUsers.map(u => `<option value="${u.id}">${u.full_name} ‚Äî ${u.email}</option>`).join('');

                document.getElementById('st-users').textContent = allUsers.length;
            } catch(e) { console.error('loadUsers error:', e); }
        }

        async function loadStats() {
            try {
                const res = await apiFetch('/admin/stats');
                if (res && res.ok) {
                    const data = await res.json();
                    document.getElementById('st-balance').textContent = formatCOP(data.totalBalance || 0);
                    document.getElementById('st-loans').textContent = formatCOP(data.totalLoans || 0);
                    document.getElementById('st-withdrawals').textContent = formatCOP(data.totalWithdrawals || 0);
                }
            } catch(e) { console.log('Stats no disponibles a√∫n'); }
        }

        async function loadRecentTransactions() {
            try {
                const res = await apiFetch('/admin/transactions/recent');
                if (!res || !res.ok) return;
                const data = await res.json();
                const tbody = document.getElementById('tx-table');
                if (!data.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="color:var(--muted);text-align:center">No hay transacciones</td></tr>';
                    return;
                }
                const typeLabels = {deposit:'Dep√≥sito',withdraw:'Retiro',payment:'Abono',interest:'Intereses',profit:'Ganancias',loan:'Pr√©stamo',investment:'Inversi√≥n',investment_return:'Rendimiento SDTC'};
                const typeBadge = {deposit:'badge-green',withdraw:'badge-red',payment:'badge-blue',interest:'badge-gold',profit:'badge-green',loan:'badge-purple',investment:'badge-blue',investment_return:'badge-green'};
                tbody.innerHTML = data.map(tx => `
                    <tr>
                        <td class="mono">${tx.ref_id || tx.id}</td>
                        <td>${tx.user_name || 'ID: '+tx.user_id}</td>
                        <td><span class="badge ${typeBadge[tx.type]||'badge-blue'}">${typeLabels[tx.type]||tx.type}</span></td>
                        <td class="mono" style="color:${['withdraw'].includes(tx.type)?'var(--red)':'var(--green)'}">${['withdraw'].includes(tx.type)?'-':'+'} ${formatCOP(tx.amount)}</td>
                        <td style="color:var(--text2)">${tx.description||'‚Äî'}</td>
                        <td style="color:var(--muted)">${formatDate(tx.created_at)}</td>
                    </tr>
                `).join('');
            } catch(e) { document.getElementById('tx-table').innerHTML = '<tr><td colspan="6" style="color:var(--muted);text-align:center">Sin datos</td></tr>'; }
        }

        // ====== RENDIMIENTOS SDTC ======
        async function loadActiveInvestments() {
            const container = document.getElementById('active-investments-list');
            const returnsTable = document.getElementById('returns-table');
            
            try {
                const res = await apiFetch('/admin/investments/active');
                if (!res || !res.ok) {
                    container.innerHTML = '<div style="color:var(--red);text-align:center;padding:20px;">Error cargando inversiones. Verifica que el backend est√© actualizado.</div>';
                    return;
                }
                activeInvestments = await res.json();

                if (!activeInvestments.length) {
                    container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:40px 0;">No hay inversiones activas. Los usuarios deben crear una inversi√≥n SDTC primero.</div>';
                    returnsTable.innerHTML = '<tr><td colspan="6" style="color:var(--muted);text-align:center">Sin rendimientos</td></tr>';
                    return;
                }

                // Render investment cards
                container.innerHTML = activeInvestments.map(inv => `
                    <div class="inv-card ${selectedInvestment && selectedInvestment.id === inv.id ? 'selected' : ''}" 
                         onclick="selectInvestment(${inv.id})" id="inv-card-${inv.id}">
                        <div class="inv-card-header">
                            <div>
                                <div class="inv-card-user">${inv.userName}</div>
                                <div style="font-size:12px;color:var(--text2)">${inv.userEmail}</div>
                            </div>
                            <div class="inv-card-type">${inv.type} ‚Äî ID #${inv.id}</div>
                        </div>
                        <div class="inv-card-details">
                            <div class="inv-card-detail">
                                <span class="label">Capital</span>
                                <span class="value" style="color:var(--gold)">${formatCOP(inv.amount)}</span>
                            </div>
                            <div class="inv-card-detail">
                                <span class="label">Tasa</span>
                                <span class="value">${inv.minMonthlyRate}% ‚Äî ${inv.maxMonthlyRate}%</span>
                            </div>
                            <div class="inv-card-detail">
                                <span class="label">Inicio</span>
                                <span class="value">${formatDate(inv.startDate)}</span>
                            </div>
                            <div class="inv-card-detail">
                                <span class="label">Vence</span>
                                <span class="value">${formatDate(inv.lockEndDate || inv.endDate)}</span>
                            </div>
                            <div class="inv-card-detail">
                                <span class="label">Ganancia Total</span>
                                <span class="value" style="color:var(--green)">${formatCOP(inv.totalEarned)}</span>
                            </div>
                            <div class="inv-card-detail">
                                <span class="label">Meses Pagados</span>
                                <span class="value">${inv.returnsCount} / 6</span>
                            </div>
                        </div>
                        ${inv.returns.length > 0 ? `
                            <div class="inv-card-returns">
                                <div class="inv-card-returns-title">Rendimientos registrados</div>
                                ${inv.returns.map(r => `<span class="return-tag">${r.month.slice(0,7)} ‚Üí ${r.rate}% ‚Üí ${formatCOP(r.earned)}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                // Build returns history table from all investments
                const allReturns = [];
                activeInvestments.forEach(inv => {
                    inv.returns.forEach(r => {
                        allReturns.push({
                            invId: inv.id,
                            userName: inv.userName,
                            month: r.month,
                            rate: r.rate,
                            earned: r.earned,
                            capital: inv.amount,
                        });
                    });
                });

                if (allReturns.length > 0) {
                    allReturns.sort((a, b) => b.month.localeCompare(a.month));
                    returnsTable.innerHTML = allReturns.map(r => `
                        <tr>
                            <td class="mono">#${r.invId}</td>
                            <td style="font-weight:600">${r.userName}</td>
                            <td class="mono">${r.month.slice(0,7)}</td>
                            <td><span class="badge badge-gold">${r.rate}%</span></td>
                            <td class="mono" style="color:var(--green)">+${formatCOP(r.earned)}</td>
                            <td class="mono" style="color:var(--text2)">${formatCOP(r.capital)}</td>
                        </tr>
                    `).join('');
                } else {
                    returnsTable.innerHTML = '<tr><td colspan="6" style="color:var(--muted);text-align:center">A√∫n no se han registrado rendimientos</td></tr>';
                }

            } catch(e) {
                console.error('loadActiveInvestments error:', e);
                container.innerHTML = '<div style="color:var(--red);text-align:center;padding:20px;">Error: ' + e.message + '</div>';
            }
        }

        function selectInvestment(invId) {
            const inv = activeInvestments.find(i => i.id === invId);
            if (!inv) return;

            selectedInvestment = inv;

            // Update card styles
            document.querySelectorAll('.inv-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`inv-card-${invId}`).classList.add('selected');

            // Show form
            const form = document.getElementById('return-form');
            form.style.display = 'block';
            document.getElementById('rf-inv-label').textContent = `${inv.userName} ‚Äî ${inv.type} #${inv.id} ‚Äî ${formatCOP(inv.amount)}`;

            // Set default month to next unpaid month
            const paidMonths = inv.returns.map(r => r.month.slice(0, 7));
            const startDate = new Date(inv.startDate);
            let nextMonth = null;
            for (let i = 0; i < 6; i++) {
                const d = new Date(startDate);
                d.setMonth(d.getMonth() + i + 1);
                const monthStr = d.toISOString().slice(0, 7);
                if (!paidMonths.includes(monthStr)) {
                    nextMonth = monthStr;
                    break;
                }
            }
            if (nextMonth) {
                document.getElementById('rf-month').value = nextMonth;
            }

            // Clear rate
            document.getElementById('rf-rate').value = '';
            document.getElementById('rf-notes').value = '';
            document.getElementById('return-preview').style.display = 'none';
            document.getElementById('btn-register-return').disabled = true;

            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function updateReturnPreview() {
            if (!selectedInvestment) return;

            const rate = parseFloat(document.getElementById('rf-rate').value);
            const month = document.getElementById('rf-month').value;
            const preview = document.getElementById('return-preview');
            const btn = document.getElementById('btn-register-return');

            if (!rate || rate <= 0 || !month) {
                preview.style.display = 'none';
                btn.disabled = true;
                return;
            }

            const capital = selectedInvestment.amount;
            const earned = Math.round(capital * (rate / 100));

            document.getElementById('rp-capital').textContent = formatCOP(capital);
            document.getElementById('rp-rate').textContent = rate + '%';
            document.getElementById('rp-earned').textContent = '+' + formatCOP(earned);

            preview.style.display = 'block';
            btn.disabled = false;
        }

        async function registerReturn() {
            if (!selectedInvestment) return toast('Selecciona una inversi√≥n primero', 'error');

            const rate = parseFloat(document.getElementById('rf-rate').value);
            const month = document.getElementById('rf-month').value;
            const notes = document.getElementById('rf-notes').value.trim();

            if (!rate || rate <= 0) return toast('Ingresa una tasa v√°lida', 'error');
            if (!month) return toast('Selecciona el mes del rendimiento', 'error');

            const btn = document.getElementById('btn-register-return');
            btn.disabled = true;
            btn.textContent = 'Registrando...';

            try {
                const periodMonth = month + '-01'; // Convert "2026-03" to "2026-03-01"

                const res = await apiFetch(`/admin/investments/${selectedInvestment.id}/return`, {
                    method: 'POST',
                    body: JSON.stringify({ rate, periodMonth, notes: notes || undefined }),
                });

                if (!res) return;
                const data = await res.json();

                if (!res.ok) {
                    toast(data.error || 'Error registrando rendimiento', 'error');
                    return;
                }

                toast(`‚úÖ Rendimiento de ${formatCOP(data.return.amountEarned)} registrado para ${selectedInvestment.userName}`);

                // Reset form
                selectedInvestment = null;
                document.getElementById('return-form').style.display = 'none';
                document.getElementById('return-preview').style.display = 'none';

                // Reload data
                await loadActiveInvestments();
                loadRecentTransactions();
                loadStats();

            } catch(e) {
                toast('Error: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìà Registrar Rendimiento';
            }
        }

        // ====== CREATE USER ======
        async function createUser() {
            const btn = document.getElementById('btn-create-user');
            const body = {
                email: document.getElementById('u-email').value.trim(),
                password: document.getElementById('u-pass').value,
                fullName: document.getElementById('u-name').value.trim(),
                phone: document.getElementById('u-phone').value.trim() || undefined,
                documentNumber: document.getElementById('u-cc').value.trim() || undefined,
                role: document.getElementById('u-role').value,
            };
            const initialBalance = parseFloat(document.getElementById('u-balance').value) || 0;

            if (!body.email || !body.password || !body.fullName) return toast('Completa nombre, email y contrase√±a', 'error');

            btn.disabled = true; btn.textContent = 'Creando...';
            try {
                const res = await apiFetch('/auth/users', { method:'POST', body:JSON.stringify(body) });
                if (!res) return;
                const data = await res.json();
                if (!res.ok) return toast(data.error, 'error');

                if (initialBalance > 0) {
                    await apiFetch('/admin/balance', {
                        method:'POST',
                        body: JSON.stringify({ userId: data.userId, balance: initialBalance })
                    });
                    await apiFetch('/admin/transactions', {
                        method:'POST',
                        body: JSON.stringify({ userId: data.userId, type:'deposit', amount:initialBalance, description:'Balance inicial' })
                    });
                }

                toast(`‚úÖ ${body.fullName} creado exitosamente`);
                ['u-name','u-email','u-pass','u-phone','u-cc'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('u-balance').value = '0';
                loadData();
            } catch(e) { toast('Error: ' + e.message, 'error'); }
            finally { btn.disabled = false; btn.textContent = 'üë§ Crear Usuario'; }
        }

        // ====== CREATE TRANSACTION ======
        async function createTransaction() {
            const btn = document.getElementById('btn-create-tx');
            const userId = parseInt(document.getElementById('t-user').value);
            const type = document.getElementById('t-type').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const date = document.getElementById('t-date').value;
            const desc = document.getElementById('t-desc').value.trim();

            if (!userId) return toast('Selecciona un usuario', 'error');
            if (!amount || amount <= 0) return toast('Ingresa un monto v√°lido', 'error');

            btn.disabled = true; btn.textContent = 'Registrando...';
            try {
                const body = {
                    userId, type, amount,
                    description: desc || undefined,
                    date: date ? new Date(date).toISOString() : undefined,
                };

                const res = await apiFetch('/admin/transactions', { method:'POST', body:JSON.stringify(body) });
                if (!res) return;
                const data = await res.json();
                if (!res.ok) return toast(data.error, 'error');

                const typeLabels = {deposit:'Dep√≥sito',withdraw:'Retiro',payment:'Abono',interest:'Intereses',profit:'Ganancias',loan:'Pr√©stamo'};
                toast(`‚úÖ ${typeLabels[type]} de ${formatCOP(amount)} registrado`);
                ['t-amount','t-desc'].forEach(id => document.getElementById(id).value = '');
                loadRecentTransactions();
                loadStats();
            } catch(e) { toast('Error: ' + e.message, 'error'); }
            finally { btn.disabled = false; btn.textContent = 'üí∏ Registrar Transacci√≥n'; }
        }

        // ====== INIT ======
        document.getElementById('t-date').valueAsDate = new Date();
        loadData();
    </script>
</body>
</html>